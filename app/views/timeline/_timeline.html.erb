<%= render :partial => 'timeline/timeline_style' %>

<!-- ì—¬ê¸°ì— ì—¬ëŸ¬ íƒ€ì„ë¼ì¸ì„ í¸ì§‘í•  ìˆ˜ ìˆê²Œ íƒ­ ì¶”ê°€ -->
<div class="tabs tabs-wrap">
  <ul>
  <% @timeline_names.each_with_index do |name, index| %>
    <li><a href="#" class="timeline-tab" data-timeline-name="<%= name %>"><%= name %></a></li>
  <% end %>
  <li><a href="#" class="add-timeline-btn">+</a></li>
  </ul>
</div>

<%
# ë‚ ì§œ ë²”ìœ„ ê³„ì‚° (ì´ì „ 3ê°œì›”ë¶€í„° ì•ìœ¼ë¡œ 12ê°œì›”)
start_date = Date.today.beginning_of_month - 3.months
end_date = Date.today.beginning_of_month + 16.months

# ì›”ë³„ ì •ë³´ ìƒì„±
months = []
current_month = start_date
while current_month <= end_date
  months << {
    date: current_month,
    name: current_month.strftime("%mì›”"),
    year: current_month.year,
    days: current_month.end_of_month.day
  }
  current_month = current_month.next_month
end

# ì¼ë³„ ì •ë³´ ìƒì„±
days = []
months.each do |month|
  (1..month[:days]).each do |day_num|
    day_date = Date.new(month[:year], month[:date].month, day_num)
    days << {
      date: day_date,
      day: day_num,
      month: month[:date].month,
      year: month[:year]
    }
  end
end

# ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„° ì‚¬ìš© (load_timeline_data API í˜•ì‹)
all_timelines_data = @all_timelines || {categories: []}
all_timelines = all_timelines_data[:categories] || all_timelines_data['categories'] || []

# ê° ì…€ì˜ ë„ˆë¹„ ê³„ì‚° (ì¼ ë‹¨ìœ„)
cell_width = 18
total_width = days.length * cell_width

# ì˜¤ëŠ˜ ìœ„ì¹˜ ê³„ì‚°
today_position = (Date.today - start_date).to_i * cell_width
%>

<div class="timeline-container">
  <!-- ì‚¬ì´ë“œë°” -->
  <div class="timeline-sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">í”„ë¡œì íŠ¸ íƒ€ì„ë¼ì¸</div>
      <button class="add-category-btn" id="addCategoryBtn" title="ì¹´í…Œê³ ë¦¬ ì¶”ê°€">
        +
      </button>
    </div>
    
    <div class="sidebar-content">
      <!-- JavaScriptë¡œ ë™ì  ìƒì„±ë¨ -->
    </div>
  </div>

  <!-- íƒ€ì„ë¼ì¸ -->
  <div class="timeline-main">
    <div class="timeline-main-inner" style="width: <%= total_width %>px;">
      <!-- í—¤ë” -->
      <div class="timeline-header">
        <!-- ì›” í—¤ë” -->
        <div class="month-header">
          <% months.each do |month| %>
            <div class="month-cell" style="width: <%= cell_width * month[:days] %>px;">
              <%= month[:year] %>ë…„ <%= month[:name] %>
            </div>
          <% end %>
        </div>
        
        <!-- ì¼ í—¤ë” -->
        <div class="day-header">
          <% days.each_with_index do |day, index| %>
            <%
              # ìš”ì¼ í™•ì¸ (0: ì¼ìš”ì¼, 6: í† ìš”ì¼)
              wday = day[:date].wday
              weekend_class = case wday
                when 0 then 'sunday'     # ì¼ìš”ì¼
                when 6 then 'saturday'   # í† ìš”ì¼
                else ''
                end
            %>
            <div class="day-cell <%= weekend_class %>" style="width: <%= cell_width %>px;">
              <%= day[:day] %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- ë°”ë”” -->
      <div class="timeline-body">
        <!-- ë‚ ì§œ êµ¬ë¶„ì„  -->
        <div class="date-grid-lines">
          <% days.each_with_index do |day, index| %>
            <%
              # ì›”ìš”ì¼ì¸ì§€ í™•ì¸ (1: ì›”ìš”ì¼)
              monday_class = day[:date].wday == 1 ? 'monday-line' : ''
            %>
            <div class="date-grid-line <%= monday_class %>" style="left: <%= index * cell_width %>px;"></div>
          <% end %>
        </div>

        <!-- ì˜¤ëŠ˜ í‘œì‹œ -->
        <% if today_position >= 0 && today_position <= total_width %>
          <div class="today-line" style="left: <%= today_position %>px;">
            <div class="today-marker"></div>
          </div>
        <% end %>

        <!-- ê·¸ë¦¬ë“œì™€ í”„ë¡œì íŠ¸ ë°” (JavaScriptë¡œ ë™ì  ìƒì„±ë¨) -->
      </div>
    </div>
  </div>
</div>

<%= render partial: 'timeline/timeline_popup' %>

<!-- JSON ê´€ë¦¬ ë²„íŠ¼ë“¤ -->
<div class="json-controls">
  <button type="button" class="json-btn json-load-btn" id="loadJsonBtn">
    <span class="json-btn-icon">ğŸ”„</span>
    Load
  </button>
  <button type="button" class="json-btn json-save-btn" id="saveJsonBtn">
    <span class="json-btn-icon">ğŸ’¾</span>
    Save
  </button>
  <button type="button" class="json-btn json-import-btn" id="importJsonBtn">
    <span class="json-btn-icon">ğŸ“¥</span>
    Import
  </button>
  <button type="button" class="json-btn json-export-btn" id="exportJsonBtn">
    <span class="json-btn-icon">ğŸ“¤</span>
    Export
  </button>  
  <button type="button" class="json-btn json-xlsx-btn" id="exportXlsxBtn">
    <span class="json-btn-icon">ğŸ“Š</span>
    XLSX
  </button>
  <button type="button" class="json-btn json-png-btn" id="exportPngBtn">
    <span class="json-btn-icon">ğŸ–¼ï¸</span>
    PNG
  </button>
  <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
</div>

<!-- jQuery UI ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<!-- ExcelJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ (ìƒ‰ìƒ ì§€ì›) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

<!-- TX XLSX Exporter (ê³µìš© ì—‘ì…€ ìµìŠ¤í¬í„°) -->
<%= javascript_include_tag 'tx_xlsx_exporter', plugin: 'redmine_tx_0_base' %>

<!-- html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
// ì „ì—­ ë³€ìˆ˜ë“¤
var categoryColors = {};                        // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì •ë³´ ì´ˆê¸°í™” (ìƒ‰ìƒ ë³€ê²½ ê¸°ëŠ¥ì„ ìœ„í•´)
var scheduleColors = {};                        // ìŠ¤ì¼€ì¤„ë³„ ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì €ì¥ ê°ì²´
var cellWidth = <%= cell_width %>;              // ì…€ ë„ˆë¹„
var currentTimelineName = 'Default';             // í˜„ì¬ íƒ€ì„ë¼ì¸ ì´ë¦„

// ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
var currentEditingCategory = null;              // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì €ì¥
var currentEditingSchedule = null;              // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ì •ë³´ ì €ì¥
var currentEditingScheduleBar = null;           // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ë°” ì •ë³´ ì €ì¥ (ìš°í´ë¦­ í¸ì§‘ìš©)
var currentColorEditingTarget = null;           // í˜„ì¬ ìƒ‰ìƒ ë³€ê²½ ì¤‘ì¸ ëŒ€ìƒ ì •ë³´ ì €ì¥
var selectedColor = '#6c757d';                  // í˜„ì¬ ì„ íƒëœ ìƒ‰ìƒ
var dragThreshold = 5;                          // ë“œë˜ê·¸ ê°ì§€ë¥¼ ìœ„í•œ ë³€ìˆ˜ (5px ì´ìƒ ì›€ì§ì´ë©´ ë“œë˜ê·¸ë¡œ ê°„ì£¼)
var deletingCategoryIndex = null;               // ì‚­ì œ ì¤‘ì¸ ì¹´í…Œê³ ë¦¬ ì¸ë±ìŠ¤

// ìŠ¤í¬ë¡¤ ë™ê¸°í™” ê´€ë ¨ ë³€ìˆ˜
var isScrollSyncing = false;                    // ë¬´í•œ ë£¨í”„ ë°©ì§€ í”Œë˜ê·¸
var syncAnimationFrame = null;                  // ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ ID
var lastSyncTime = 0;                           // ë§ˆì§€ë§‰ ë™ê¸°í™” ì‹œê°„
</script>

<%= render partial: 'timeline/timeline_lib', locals: { days: days, cell_width: cell_width, start_date: start_date, total_width: total_width } %>
<%= render partial: 'timeline/timeline_export', locals: { start_date: start_date, end_date: end_date, today_position: today_position } %>
<%= render partial: 'timeline/timeline_edit', locals: { days: days, cell_width: cell_width } %>

<script>
// ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ì´ˆê¸° íƒ€ì„ë¼ì¸ ë°ì´í„°
<% 
  # ì „ì²´ ë°ì´í„°ë¥¼ JavaScriptë¡œ ì „ë‹¬
%>
window.initialTimelineData = <%= raw all_timelines_data.to_json %>;

// ìŠ¤í¬ë¡¤ ë™ê¸°í™” ê¸°ëŠ¥ ì´ˆê¸°í™” í•¨ìˆ˜
function initializeScrollSync() {
  // ìŠ¤í¬ë¡¤ ë™ê¸°í™” í•¨ìˆ˜
  function syncScroll(sourceElement, targetElement, scrollTop) {
    if (syncAnimationFrame) {
      cancelAnimationFrame(syncAnimationFrame);
    }
    
    syncAnimationFrame = requestAnimationFrame(function() {
      if (!isScrollSyncing) {
        isScrollSyncing = true;
        lastSyncTime = Date.now();
        
        // íƒ€ê²Ÿ ìš”ì†Œì˜ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì„¤ì •
        targetElement.scrollTop(scrollTop);
        
        // ë” ì§§ì€ ë”œë ˆì´ë¡œ í”Œë˜ê·¸ í•´ì œ
        setTimeout(function() {
          isScrollSyncing = false;
        }, 5);
      }
      syncAnimationFrame = null;
    });
  }
  
  // ì‚¬ì´ë“œë°”ì™€ íƒ€ì„ë¼ì¸ ìŠ¤í¬ë¡¤ ë™ê¸°í™”
  $('.sidebar-content').on('scroll', function() {
    var currentTime = Date.now();
    // ë„ˆë¬´ ë¹ ë¥¸ ì—°ì† ì´ë²¤íŠ¸ëŠ” ë§ˆì§€ë§‰ ê²ƒë§Œ ì²˜ë¦¬
    if (currentTime - lastSyncTime > 2) {
      var scrollTop = $(this).scrollTop();
      syncScroll($(this), $('.timeline-body'), scrollTop);
    }
  });
  
  $('.timeline-body').on('scroll', function() {
    var currentTime = Date.now();
    // ë„ˆë¬´ ë¹ ë¥¸ ì—°ì† ì´ë²¤íŠ¸ëŠ” ë§ˆì§€ë§‰ ê²ƒë§Œ ì²˜ë¦¬
    if (currentTime - lastSyncTime > 2) {
      var scrollTop = $(this).scrollTop();
      syncScroll($(this), $('.sidebar-content'), scrollTop);
    }
  });
}

// ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡ í•¨ìˆ˜
function registerEventHandlers() {
  console.log('ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡ ì‹œì‘');
  
  // ================================
  // ì¹´í…Œê³ ë¦¬ ê´€ë ¨ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  // ================================
  
  // ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ë²„íŠ¼
  $('.add-category-btn').click(function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    var categoryName = prompt('ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
    if (categoryName && categoryName.trim() !== '') {
      addNewCategory(categoryName.trim());
    }
  });

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ë²„íŠ¼
  $(document).on('click', '.edit-category-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    var categoryHeader = $(this).closest('.category-header');
    enterEditMode(categoryHeader);
  });

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì €ì¥ ë²„íŠ¼
  $(document).on('click', '.save-category-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    var categoryHeader = $(this).closest('.category-header');
    saveCategory(categoryHeader);
  });

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì·¨ì†Œ ë²„íŠ¼
  $(document).on('click', '.cancel-category-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    var categoryHeader = $(this).closest('.category-header');
    cancelEditMode(categoryHeader);
  });

  // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ë³€ê²½ ë²„íŠ¼
  $(document).on('click', '.color-category-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    var categoryHeader = $(this).closest('.category-header');
    var categoryIndex = categoryHeader.data('category-index');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    
    currentColorEditingTarget = {
      type: 'category',
      categoryName: categoryName,
      categoryIndex: categoryIndex,
      categoryHeader: categoryHeader
    };
    
    $('#colorPickerTitle').text('ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì„ íƒ');
    $('#colorPickerTargetName').text(categoryName);
    
    var currentColor = categoryColors[categoryName] || '#6c757d';
    selectedColor = currentColor;
    updateColorSelection(currentColor);
    
    $('#colorPickerPopup').addClass('show');
  });

  // ì¹´í…Œê³ ë¦¬ ì‚­ì œ ë²„íŠ¼
  $(document).on('click', '.delete-category-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    var categoryHeader = $(this).closest('.category-header');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    deletingCategoryIndex = categoryHeader.data('category-index');
    
    if (confirm('"' + categoryName + '" ì¹´í…Œê³ ë¦¬ì™€ ëª¨ë“  í•˜ìœ„ ì´ë²¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      confirmCategoryDelete();
    } else {
      deletingCategoryIndex = null;
    }
  });

  // ì¹´í…Œê³ ë¦¬ í† ê¸€ ë²„íŠ¼
  $(document).on('click', '.category-toggle-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    var categoryHeader = $(this).closest('.category-header');
    var categoryIndex = categoryHeader.data('category-index');
    var isCollapsed = categoryHeader.hasClass('category-collapsed');
    
    if (isCollapsed) {
      categoryHeader.removeClass('category-collapsed');
      $(this).removeClass('collapsed').text('â–¼');
      $('.project-item[data-category-index="' + categoryIndex + '"]').removeClass('hidden').show();
      showTimelineRows(categoryIndex);
      setTimeout(function() { updateLineHeight(); }, 50);
    } else {
      categoryHeader.addClass('category-collapsed');
      $(this).addClass('collapsed').text('â–¶');
      $('.project-item[data-category-index="' + categoryIndex + '"]').addClass('hidden');
      hideTimelineRows(categoryIndex);
      setTimeout(function() { updateLineHeight(); }, 50);
    }
  });

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì…ë ¥ í•„ë“œì—ì„œ Enter/Escape í‚¤ ì²˜ë¦¬
  $(document).on('keydown', '.category-edit-input', function(e) {
    var categoryHeader = $(this).closest('.category-header');
    if (e.key === 'Enter') {
      e.preventDefault();
      saveCategory(categoryHeader);
    } else if (e.key === 'Escape') {
      e.preventDefault();
      cancelEditMode(categoryHeader);
    }
  });

  // ================================
  // ì´ë²¤íŠ¸ ê´€ë ¨ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  // ================================
  
  // ì´ë²¤íŠ¸ ì¶”ê°€ ë²„íŠ¼
  $(document).on('click', '.add-event-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    var categoryHeader = $(this).closest('.category-header');
    var categoryIndex = categoryHeader.data('category-index');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    
    currentEditingCategory = { index: categoryIndex, name: categoryName };
    $('#eventCategoryName').text(categoryName);
    $('#eventName').val('');
    $('#eventPopup').addClass('show');
    
    setTimeout(function() { $('#eventName').focus(); }, 100);
  });

  // ì´ë²¤íŠ¸ íŒì—… ì·¨ì†Œ ë²„íŠ¼
  $('#cancelEventBtn').click(function(e) {
    e.preventDefault();
    hideEventPopup();
  });

  // ì´ë²¤íŠ¸ íŒì—… ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
  $('#eventPopup').click(function(e) {
    if (e.target === this) {
      hideEventPopup();
    }
  });

  // ì´ë²¤íŠ¸ í¼ ì œì¶œ ì²˜ë¦¬
  $('#eventForm').submit(function(e) {
    e.preventDefault();
    
    var eventName = $('#eventName').val().trim();
    if (!eventName) {
      alert('ì´ë²¤íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      $('#eventName').focus();
      return;
    }
    
    if (!currentEditingCategory) {
      alert('ì¹´í…Œê³ ë¦¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    addNewEvent(currentEditingCategory.index, { name: eventName });
    hideEventPopup();
  });

  // ================================
  // íƒ€ì„ë¼ì¸ íƒ­ ê´€ë ¨ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  // ================================
  
  // íƒ­ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  $('.timeline-tab').click(function(e) {
    e.preventDefault();
    
    var timelineName = $(this).data('timeline-name');
    
    // currentTimelineName ì—…ë°ì´íŠ¸
    currentTimelineName = timelineName;
    
    // ì„ íƒëœ íƒ­ UI ì—…ë°ì´íŠ¸
    selectTimelineTab(timelineName);
    
    // ì„ íƒëœ íƒ€ì„ë¼ì¸ ë°ì´í„° ë¡œë“œ
    loadTimelineFromServer(timelineName);
    
    console.log('íƒ€ì„ë¼ì¸ íƒ­ ë³€ê²½ë¨:', timelineName);
  });
  
  // ìƒˆ íƒ€ì„ë¼ì¸ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('.add-timeline-btn').click(function(e) {
    e.preventDefault();
    
    // ìƒˆ íƒ€ì„ë¼ì¸ ì´ë¦„ ì…ë ¥ë°›ê¸°
    var newTimelineName = prompt('ìƒˆ íƒ€ì„ë¼ì¸ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', '');
    
    if (newTimelineName && newTimelineName.trim() !== '') {
      newTimelineName = newTimelineName.trim();
      
      // ì„œë²„ì— ìƒˆ íƒ€ì„ë¼ì¸ ìƒì„± ìš”ì²­
      $.ajax({
        url: '<%= create_timeline_project_timeline_index_path(@project) %>',
        method: 'POST',
        headers: {
          'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content'),
          'Content-Type': 'application/json'
        },
        data: JSON.stringify({
          name: newTimelineName
        }),
        success: function(response) {
          if (response.success) {
            alert('ìƒˆ íƒ€ì„ë¼ì¸ "' + newTimelineName + '"ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìƒˆ íƒ­ í‘œì‹œ
            window.location.reload();
          } else {
            alert('ë¡œë“œë§µ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (response.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
        },
        error: function(xhr, status, error) {
          console.error('ìƒˆ íƒ€ì„ë¼ì¸ ìƒì„± ì‹¤íŒ¨:', {
            status: xhr.status,
            statusText: xhr.statusText,
            responseText: xhr.responseText,
            error: error
          });
          alert('ìƒˆ íƒ€ì„ë¼ì¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nìƒíƒœ: ' + xhr.status + '\nì˜¤ë¥˜: ' + error);
        }
      });
    }
  });

  console.log('ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡ ì™„ë£Œ');
}

$(document).ready(function() {  
  console.log('íƒ€ì„ë¼ì¸ ì´ˆê¸°í™” ì‹œì‘');
  
  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° íƒ­ ì„ íƒ
  selectTimelineTab(currentTimelineName);
  console.log('ì´ˆê¸° íƒ­ ì„ íƒ ì™„ë£Œ:', currentTimelineName);
  
  // ì´ˆê¸° ë°ì´í„°ë¡œ í˜ì´ì§€ êµ¬ì„±
  if (window.initialTimelineData && window.initialTimelineData.categories) {
    console.log('ì´ˆê¸° ë°ì´í„°ë¡œ í˜ì´ì§€ êµ¬ì„± ì‹œì‘:', window.initialTimelineData);
    applyImportedData(window.initialTimelineData);
    console.log('ì´ˆê¸° í˜ì´ì§€ êµ¬ì„± ì™„ë£Œ');
  }
  
  // ê¸°ì¡´ ìŠ¤ì¼€ì¥´ë°”ë“¤ì— ì´ìŠˆ ë§í¬ ì•„ì´ì½˜ ì¶”ê°€ ë° ìŠ¤ì¼€ì¤„ ì›ë¬¸ ì†ì„± ë³´ì •
  setTimeout(function() {
    addIssueLinkIconsToExistingBars();
    if (typeof initializeScheduleNameAttributes === 'function') {
      initializeScheduleNameAttributes();
    }
  }, 200);
  
  // bodyì— í´ë˜ìŠ¤ ì¶”ê°€ë¡œ ì „ì²´ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì œì–´
  $('body').addClass('timeline-view');
  
  // ì˜¤ëŠ˜ ë‚ ì§œ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤
  var todayPosition = <%= today_position %>;
  var timelineContainer = $('.timeline-main');
  var containerWidth = timelineContainer.width();
  
  // ì˜¤ëŠ˜ì´ í™”ë©´ ì¤‘ì•™ì— ì˜¤ë„ë¡ ìŠ¤í¬ë¡¤
  var scrollLeft = Math.max(0, todayPosition - containerWidth * 0.2 );
  timelineContainer.scrollLeft(scrollLeft);

  // ìŠ¤í¬ë¡¤ ë™ê¸°í™” ê¸°ëŠ¥ ì´ˆê¸°í™”
  initializeScrollSync();
  
  // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
  registerEventHandlers();

  // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì´ˆê¸°í™”
  initializeEventDragAndDrop();
  initializeCategoryDragAndDrop();
  
  // ë“œë˜ê·¸ ê¸°ëŠ¥ ì„¤ì •
  initializeProjectBarDraggable();
  
  // ì´ˆê¸° ë¼ì¸ ë†’ì´ ì„¤ì •
  setTimeout(function() {
    updateLineHeight();
  }, 100);

  

  // ë§ˆìš°ìŠ¤ ë‹¤ìš´ ì´ë²¤íŠ¸ - ì‹œì‘ ìœ„ì¹˜ ì €ì¥ (íƒ€ì„ë¼ì¸ í–‰ì—ì„œ ì²˜ë¦¬)
  $(document).on('mousedown', '.timeline-row', function(e) {
    // í”„ë¡œì íŠ¸ ë°” í´ë¦­ì€ ë¬´ì‹œ
    if ($(e.target).hasClass('project-bar') || $(e.target).closest('.project-bar').length > 0) {
      return;
    }
    
    var downTime = Date.now();
    $(this).data('mousedown-x', e.clientX);
    $(this).data('mousedown-y', e.clientY);
    $(this).data('mousedown-time', downTime);
  });

  // ë§ˆìš°ìŠ¤ ì—… ì´ë²¤íŠ¸ - ì¢…ë£Œ ìœ„ì¹˜ ì €ì¥ (íƒ€ì„ë¼ì¸ í–‰ì—ì„œ ì²˜ë¦¬)
  $(document).on('mouseup', '.timeline-row', function(e) {
    // í”„ë¡œì íŠ¸ ë°” í´ë¦­ì€ ë¬´ì‹œ
    if ($(e.target).hasClass('project-bar') || $(e.target).closest('.project-bar').length > 0) {
      return;
    }
    
    $(this).data('mouseup-x', e.clientX);
    $(this).data('mouseup-y', e.clientY);
  });

  // íƒ€ì„ë¼ì¸ í–‰ ì „ì²´ì—ì„œ ë¹ˆ ì˜ì—­ í´ë¦­ ê°ì§€
  $(document).on('click', '.timeline-row', function(e) {
    // í´ë¦­ëœ ìš”ì†Œê°€ í”„ë¡œì íŠ¸ ë°”ì´ê±°ë‚˜ í”„ë¡œì íŠ¸ ë°”ì˜ ìì‹ ìš”ì†Œì¸ ê²½ìš° ë¬´ì‹œ
    if ($(e.target).hasClass('project-bar') || $(e.target).closest('.project-bar').length > 0) {
      return;
    }
    
    // í´ë¦­ ìœ„ì¹˜ì—ì„œ í•´ë‹¹í•˜ëŠ” ì…€ ì°¾ê¸°
    var clickedCell = null;
    var clickX = e.offsetX || e.originalEvent.layerX;
    
    // í´ë¦­ëœ ìš”ì†Œê°€ timeline-cellì¸ì§€ í™•ì¸
    if ($(e.target).hasClass('timeline-cell')) {
      clickedCell = $(e.target);
    } else if ($(e.target).closest('.timeline-cell').length > 0) {
      clickedCell = $(e.target).closest('.timeline-cell');
    } else {
      // í´ë¦­ ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì…€ ì°¾ê¸°
      var timelineRow = $(this);
      var cells = timelineRow.find('.timeline-cell');
      var cellIndex = Math.floor(clickX / cellWidth);
      
      if (cellIndex >= 0 && cellIndex < cells.length) {
        clickedCell = cells.eq(cellIndex);
      }
    }
    
    if (!clickedCell || !clickedCell.hasClass('schedule-add-target')) {
      return;
    }
    
    // ì‹œê°„ ë° ê±°ë¦¬ ì œí•œ í™•ì¸ (íƒ€ì„ë¼ì¸ í–‰ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°)
    var downX = $(this).data('mousedown-x');
    var downY = $(this).data('mousedown-y');
    var upX = $(this).data('mouseup-x');
    var upY = $(this).data('mouseup-y');
    var downTime = $(this).data('mousedown-time');
    
    // ì‹œê°„ ì œí•œ í™•ì¸ (0.2ì´ˆ = 200ms)
    var currentTime = Date.now();
    var timeDiff = downTime ? (currentTime - downTime) : 0;
    
    if (timeDiff > 200) {
      return;
    }
    
    // ê±°ë¦¬ ì œí•œ í™•ì¸
    if (downX !== undefined && downY !== undefined && upX !== undefined && upY !== undefined) {
      var deltaX = Math.abs(upX - downX);
      var deltaY = Math.abs(upY - downY);
      
      if (deltaX > dragThreshold || deltaY > dragThreshold) {
        return;
      }
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    var timelineRow = $(this);
    var clickedDate = clickedCell.data('date');
    var eventName = timelineRow.data('event-name');
    var categoryName = timelineRow.data('category-name');
    
    // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ì •ë³´ ì €ì¥
    currentEditingSchedule = {
      eventName: eventName,
      categoryName: categoryName,
      clickedDate: clickedDate,
      timelineRow: timelineRow
    };
    
    // íŒì—…ì— ì •ë³´ ì„¤ì •
    $('#scheduleEventName').text(eventName);
    $('#scheduleCategoryName').text('(' + categoryName + ')');
    
    // í¼ ì´ˆê¸°í™”
    $('#scheduleName').val('');
    $('#scheduleStartDate').val(clickedDate);
    
    // ì¢…ë£Œì¼ì„ ì‹œì‘ì¼ë¡œë¶€í„° 1ì£¼ì¼ ë’¤ë¡œ ì„¤ì •
    var startDateObj = new Date(clickedDate);
    var endDateObj = new Date(startDateObj);
    endDateObj.setDate(endDateObj.getDate() + 6); // 1ì£¼ì¼ ë’¤
    var endDateString = endDateObj.toISOString().split('T')[0];
    $('#scheduleEndDate').val(endDateString);
    
    $('#scheduleIssue').val('');
    
    // íŒì—… í‘œì‹œ
    $('#schedulePopup').addClass('show');
    
    // í¬ì»¤ìŠ¤ ì„¤ì •
    setTimeout(function() {
      $('#scheduleName').focus();
    }, 100);
  });

  // ìŠ¤ì¼€ì¤„ íŒì—… ì·¨ì†Œ ë²„íŠ¼
  $('#cancelScheduleBtn').click(function(e) {
    e.preventDefault();
    hideSchedulePopup();
  });

  // ìŠ¤ì¼€ì¤„ íŒì—… ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
  $('#schedulePopup').click(function(e) {
    if (e.target === this) {
      hideSchedulePopup();
    }
  });

  // ê¸°ê°„ ì„¤ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.duration-btn', function(e) {
    e.preventDefault();
    
    var weeks = parseInt($(this).data('weeks'));
    var startDate = $('#scheduleStartDate').val();
    
    if (startDate) {
      var startDateObj = new Date(startDate);
      var endDateObj = new Date(startDateObj);
      endDateObj.setDate(endDateObj.getDate() + (weeks * 7) - 1);
      
      var endDateString = endDateObj.toISOString().split('T')[0];
      $('#scheduleEndDate').val(endDateString);
      
      // ë²„íŠ¼ ì‹œê°ì  í”¼ë“œë°±
      $(this).css('transform', 'scale(0.95)');
      setTimeout(() => {
        $(this).css('transform', '');
      }, 150);
    } else {
      alert('ë¨¼ì € ì‹œì‘ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    }
  });

  // ì‹œì‘ì¼ ë³€ê²½ì‹œ ìë™ìœ¼ë¡œ ì¢…ë£Œì¼ì„ 1ì£¼ì¼ ë’¤ë¡œ ì„¤ì • (ì¢…ë£Œì¼ ë¯¸í¬í•¨ ë°©ì‹)
  $('#scheduleStartDate').change(function() {
    var startDate = $(this).val();
    if (startDate) {
      var startDateObj = new Date(startDate);
      var endDateObj = new Date(startDateObj);
      endDateObj.setDate(endDateObj.getDate() + 7); // 1ì£¼ì¼ ë’¤ (ì¢…ë£Œì¼ ë¯¸í¬í•¨ ë°©ì‹)
      
      var endDateString = endDateObj.toISOString().split('T')[0];
      $('#scheduleEndDate').val(endDateString);
      

    }
  });

  // ìŠ¤ì¼€ì¤„ í¼ ì œì¶œ ì²˜ë¦¬
  $('#scheduleForm').submit(function(e) {
    e.preventDefault();
    
    if (!currentEditingSchedule) {
      console.error('í¸ì§‘ ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    var scheduleName = $('#scheduleName').val().trim();
    var startDate = $('#scheduleStartDate').val();
    var endDate = $('#scheduleEndDate').val();
    var issueNumber = $('#scheduleIssue').val();
    
    if (!scheduleName || !startDate || !endDate) {
      alert('ì¼ì •ëª…, ì‹œì‘ì¼, ì¢…ë£Œì¼ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
      return;
    }
    
    // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
    if (new Date(startDate) > new Date(endDate)) {
      alert('ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    

    
    // ìƒˆ ìŠ¤ì¼€ì¤„ ë°” ì¶”ê°€
    addNewSchedule(currentEditingSchedule, {
      name: scheduleName,
      start_date: parseLocalDate(startDate),
      end_date: parseLocalDate(endDate),
      issue: issueNumber,
      done_ratio: null
    });
    
    // íŒì—… ë‹«ê¸°
    hideSchedulePopup();
  });

  /*
  // ì´ë²¤íŠ¸ í¼ ì œì¶œ ì²˜ë¦¬
  $('#eventForm').submit(function(e) {
    e.preventDefault();
    
    var eventName = $('#eventName').val().trim();
    
    if (!eventName) {
      alert('ì´ë²¤íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      $('#eventName').focus();
      return;
    }
    
    if (!currentEditingCategory) {
      alert('ì¹´í…Œê³ ë¦¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    // ìƒˆ ì´ë²¤íŠ¸ ë°ì´í„° ìƒì„± (ìŠ¤ì¼€ì¤„ ì •ë³´ ì—†ì´)
    var eventData = {
      name: eventName
    };
    
    // ì´ë²¤íŠ¸ ì¶”ê°€
    addNewEvent(currentEditingCategory.index, eventData);
    
    // íŒì—… ë‹«ê¸°
    hideEventPopup();
  });
  */


  // ìƒ‰ìƒ íŒì—… ê´€ë ¨ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
  
  // ê¸°ë³¸ ìƒ‰ìƒ ì„ íƒ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.color-preset-item', function(e) {
    e.preventDefault();
    var color = $(this).data('color');
    selectedColor = color;
    updateColorSelection(color);
    $('#customColorPicker').val(color);
  });
  
  // ì‚¬ìš©ì ì§€ì • ìƒ‰ìƒ ë³€ê²½ ì´ë²¤íŠ¸
  $('#customColorPicker').on('input', function(e) {
    var color = $(this).val();
    selectedColor = color;
    updateColorSelection(color);
  });
  
  // ìƒ‰ìƒ ì ìš© ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#applyColorBtn').click(function(e) {
    e.preventDefault();
    
    if (!currentColorEditingTarget) {
      console.error('ìƒ‰ìƒ ë³€ê²½ ì¤‘ì¸ ëŒ€ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    if (currentColorEditingTarget.type === 'category') {
      // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì €ì¥
      categoryColors[currentColorEditingTarget.categoryName] = selectedColor;
      
      // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  ì´ë²¤íŠ¸ë“¤ì˜ ìŠ¤ì¼€ì¤„ ë°” ìƒ‰ìƒ ì—…ë°ì´íŠ¸
      updateCategoryScheduleColors(currentColorEditingTarget.categoryName, selectedColor);
    } else if (currentColorEditingTarget.type === 'schedule') {
      // ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì €ì¥
      var scheduleKey = currentColorEditingTarget.scheduleKey;
      var categoryColor = getCategoryColor(currentColorEditingTarget.categoryName);
      
      // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒê³¼ ê°™ìœ¼ë©´ ê°œë³„ ìƒ‰ìƒ ì œê±°
      if (selectedColor === categoryColor) {
        delete scheduleColors[scheduleKey];
      } else {
        scheduleColors[scheduleKey] = selectedColor;
      }
      
      // ìƒ‰ìƒ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
      $('#scheduleColorPreview').css('background-color', selectedColor);
      
      // ìŠ¤ì¼€ì¤„ í¸ì§‘ ìƒ‰ìƒ ê°’ ì €ì¥
      if (currentColorEditingTarget.colorValue) {
        currentColorEditingTarget.colorValue = selectedColor;
      }
    }
    
    // íŒì—… ë‹«ê¸°
    hideColorPickerPopup();
  });
  
  // ìƒ‰ìƒ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#cancelColorBtn').click(function(e) {
    e.preventDefault();
    hideColorPickerPopup();
  });
  
  // ìƒ‰ìƒ íŒì—… ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
  $('#colorPickerPopup').click(function(e) {
    if (e.target === this) {
      hideColorPickerPopup();
    }
  });

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ì¸ë¼ì¸ í¸ì§‘ ëª¨ë“œë¡œ ë³€ê²½)
  $(document).on('click', '.edit-category-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    var categoryHeader = $(this).closest('.category-header');
    enterEditMode(categoryHeader);
  });

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.save-category-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();

    
    var categoryHeader = $(this).closest('.category-header');
    saveCategory(categoryHeader);
  });

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.cancel-category-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();

    
    var categoryHeader = $(this).closest('.category-header');
    cancelEditMode(categoryHeader);
  });

  // ì´ë²¤íŠ¸ í¸ì§‘ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.edit-event-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();

    
    var eventItem = $(this).closest('.project-item');
    enterEventEditMode(eventItem);
  });

  // ì´ë²¤íŠ¸ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.delete-event-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();

    
    var eventItem = $(this).closest('.project-item');
    var eventName = eventItem.find('.project-name').text().trim();
    
    if (confirm('ì •ë§ë¡œ "' + eventName + '" ì´ë²¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ì´ë²¤íŠ¸ ë‚´ì˜ ëª¨ë“  ìŠ¤ì¼€ì¤„ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) {
      deleteEvent(eventItem);
    }
  });

  // ì´ë²¤íŠ¸ í¸ì§‘ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.save-event-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();

    
    var eventItem = $(this).closest('.project-item');
    saveEvent(eventItem);
  });

  // ì´ë²¤íŠ¸ í¸ì§‘ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.cancel-event-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();

    
    var eventItem = $(this).closest('.project-item');
    cancelEventEditMode(eventItem);
  });

  // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ë³€ê²½ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.color-category-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ë³€ê²½ ë²„íŠ¼ í´ë¦­ë¨');
    
    var categoryHeader = $(this).closest('.category-header');
    var categoryIndex = categoryHeader.data('category-index');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    
    // í˜„ì¬ ìƒ‰ìƒ ë³€ê²½ ì¤‘ì¸ ëŒ€ìƒ ì •ë³´ ì €ì¥
    currentColorEditingTarget = {
      type: 'category',
      categoryName: categoryName,
      categoryIndex: categoryIndex,
      categoryHeader: categoryHeader
    };
    
    // íŒì—… íƒ€ì´í‹€ê³¼ ëŒ€ìƒ ì´ë¦„ ì„¤ì •
    $('#colorPickerTitle').text('ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì„ íƒ');
    $('#colorPickerTargetName').text(categoryName);
    
    // í˜„ì¬ ì¹´í…Œê³ ë¦¬ì˜ ìƒ‰ìƒ ë¶ˆëŸ¬ì˜¤ê¸°
    var currentColor = categoryColors[categoryName] || '#6c757d';
    selectedColor = currentColor;
    
    // ìƒ‰ìƒ ì„ íƒ UI ì—…ë°ì´íŠ¸
    updateColorSelection(currentColor);
    
    // íŒì—… í‘œì‹œ
    $('#colorPickerPopup').addClass('show');
  });

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì…ë ¥ í•„ë“œì—ì„œ Enter/Escape í‚¤ ì²˜ë¦¬
  $(document).on('keydown', '.category-edit-input', function(e) {
    var categoryHeader = $(this).closest('.category-header');
    
    if (e.key === 'Enter') {
      e.preventDefault();
      saveCategory(categoryHeader);
    } else if (e.key === 'Escape') {
      e.preventDefault();
      cancelEditMode(categoryHeader);
    }
  });

  // ì´ë²¤íŠ¸ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì´ˆê¸°í™”
  initializeEventDragAndDrop();
  
  // ì¹´í…Œê³ ë¦¬ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì´ˆê¸°í™”
  initializeCategoryDragAndDrop();

  // ì´ë²¤íŠ¸ í¸ì§‘ ì…ë ¥ í•„ë“œì—ì„œ Enter/Escape í‚¤ ì²˜ë¦¬
  $(document).on('keydown', '.event-edit-input', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      var eventItem = $(this).closest('.project-item');
      saveEvent(eventItem);
    } else if (e.key === 'Escape') {
      e.preventDefault();
      var eventItem = $(this).closest('.project-item');
      cancelEventEditMode(eventItem);
    }
  });

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ëª¨ë“œ ì§„ì…
  function enterEditMode(categoryHeader) {
    console.log('í¸ì§‘ ëª¨ë“œ ì§„ì…');
    
    var categoryTitle = categoryHeader.find('.category-title');
    var editForm = categoryHeader.find('.category-edit-form');
    var editInput = categoryHeader.find('.category-edit-input');
    
    // í˜„ì¬ ì œëª©ì„ ì…ë ¥ í•„ë“œì— ì„¤ì •
    editInput.val(categoryTitle.text().trim());
    
    // í¸ì§‘ ëª¨ë“œ í´ë˜ìŠ¤ ì¶”ê°€
    categoryHeader.addClass('editing');
    
    // ì œëª© ìˆ¨ê¸°ê³  í¸ì§‘ í¼ í‘œì‹œ
    categoryTitle.hide();
    editForm.show();
    
    // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
    editInput.focus().select();
  }

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì €ì¥
  function saveCategory(categoryHeader) {
    console.log('ì¹´í…Œê³ ë¦¬ ì €ì¥');
    
    var categoryTitle = categoryHeader.find('.category-title');
    var editForm = categoryHeader.find('.category-edit-form');
    var editInput = categoryHeader.find('.category-edit-input');
    
    var newName = editInput.val().trim();
    
    if (newName === '') {
      alert('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
      editInput.focus();
      return;
    }
    
    // ì œëª© ì—…ë°ì´íŠ¸
    categoryTitle.text(newName);
    
    // í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ
    exitEditMode(categoryHeader);
    
    console.log('ì¹´í…Œê³ ë¦¬ ì´ë¦„ ì €ì¥ë¨:', newName);
  }

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì·¨ì†Œ
  function cancelEditMode(categoryHeader) {
    console.log('ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì·¨ì†Œ');
    exitEditMode(categoryHeader);
  }

  // í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ
  function exitEditMode(categoryHeader) {
    var categoryTitle = categoryHeader.find('.category-title');
    var editForm = categoryHeader.find('.category-edit-form');
    
    // í¸ì§‘ ëª¨ë“œ í´ë˜ìŠ¤ ì œê±°
    categoryHeader.removeClass('editing');
    
    // í¸ì§‘ í¼ ìˆ¨ê¸°ê³  ì œëª© í‘œì‹œ
    editForm.hide();
    categoryTitle.show();
  }

  // ì¹´í…Œê³ ë¦¬ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  var deletingCategoryIndex = null;
  
  $(document).on('click', '.delete-category-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('ì¹´í…Œê³ ë¦¬ ì‚­ì œ ë²„íŠ¼ í´ë¦­ë¨');
    
    var categoryHeader = $(this).closest('.category-header');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    deletingCategoryIndex = categoryHeader.data('category-index');
    
    if (confirm('"' + categoryName + '" ì¹´í…Œê³ ë¦¬ì™€ ëª¨ë“  í•˜ìœ„ ì´ë²¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      confirmCategoryDelete();
    } else {
      deletingCategoryIndex = null;
    }
  });

  // í† ê¸€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ë™ì  ìš”ì†Œ í¬í•¨)
  $(document).on('click', '.category-toggle-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    console.log('í† ê¸€ ë²„íŠ¼ í´ë¦­ë¨!');
    
    var categoryHeader = $(this).closest('.category-header');
    var categoryIndex = categoryHeader.data('category-index');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    
    console.log('í´ë¦­ëœ ì¹´í…Œê³ ë¦¬:', categoryIndex, categoryName);
    
    var isCollapsed = categoryHeader.hasClass('category-collapsed');
    console.log('í˜„ì¬ ìƒíƒœ:', isCollapsed ? 'ì ‘í˜' : 'í¼ì¹¨');
    
    if (isCollapsed) {
      // í¼ì¹˜ê¸°
      console.log('í¼ì¹˜ê¸° ì‹œì‘');
      categoryHeader.removeClass('category-collapsed');
      $(this).removeClass('collapsed').text('â–¼');
      
      // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ í”„ë¡œì íŠ¸ë“¤ë§Œ í‘œì‹œ (JavaScriptë¡œ ì§ì ‘ ì œì–´)
      $('.project-item[data-category-index="' + categoryIndex + '"]').removeClass('hidden').show();
      console.log('í”„ë¡œì íŠ¸ ì•„ì´í…œë“¤ í‘œì‹œ ì™„ë£Œ');
      
      // íƒ€ì„ë¼ì¸ì—ì„œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ í–‰ë“¤ í‘œì‹œ
      showTimelineRows(categoryIndex);
      
      // ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸ (í–‰ì´ ë‚˜íƒ€ë‚¨)
      setTimeout(function() {
        updateLineHeight();
      }, 50);
      
    } else {
      // ì ‘ê¸°
      console.log('ì ‘ê¸° ì‹œì‘');
      categoryHeader.addClass('category-collapsed');
      $(this).addClass('collapsed').text('â–¶');
      
      // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ í”„ë¡œì íŠ¸ë“¤ë§Œ ìˆ¨ê¸°ê¸° (JavaScriptë¡œ ì§ì ‘ ì œì–´)
      $('.project-item[data-category-index="' + categoryIndex + '"]').addClass('hidden');
      console.log('í”„ë¡œì íŠ¸ ì•„ì´í…œë“¤ ìˆ¨ê¸°ê¸° ì™„ë£Œ');
      
      // íƒ€ì„ë¼ì¸ì—ì„œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ í–‰ë“¤ ìˆ¨ê¸°ê¸°
      hideTimelineRows(categoryIndex);
      
      // ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸ (í–‰ì´ ìˆ¨ê²¨ì§)
      setTimeout(function() {
        updateLineHeight();
      }, 50);
    }
  });

  // ì¹´í…Œê³ ë¦¬ ì‚­ì œ í™•ì¸ í•¨ìˆ˜ (ìˆ˜ì •ëœ ë²„ì „)
  function confirmCategoryDelete() {
    if (deletingCategoryIndex === null) return;
    
    var categoryHeader = $('.category-header[data-category-index="' + deletingCategoryIndex + '"]');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    
    console.log('ì¹´í…Œê³ ë¦¬ ì‚­ì œ ì‹œì‘:', categoryName, 'ì¸ë±ìŠ¤:', deletingCategoryIndex);
    
    // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì •ë³´ ì‚­ì œ
    delete categoryColors[categoryName];
    
    // 1. íƒ€ì„ë¼ì¸ì—ì„œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ í–‰ë“¤ ë¨¼ì € ì‚­ì œ (ì‚¬ì´ë“œë°” ë³€ê²½ ì „ì—)
    deleteTimelineRowsForCategory(deletingCategoryIndex);
    
    // 2. í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  í”„ë¡œì íŠ¸ ì•„ì´í…œ ì‚­ì œ (ì‚¬ì´ë“œë°”)
    var deletedProjectCount = $('.project-item[data-category-index="' + deletingCategoryIndex + '"]').length;
    $('.project-item[data-category-index="' + deletingCategoryIndex + '"]').remove();
    console.log('ì‚­ì œëœ í”„ë¡œì íŠ¸ ì•„ì´í…œ ìˆ˜:', deletedProjectCount);
    
    // 3. ì¹´í…Œê³ ë¦¬ í—¤ë” ì‚­ì œ (ì‚¬ì´ë“œë°”)
    categoryHeader.remove();
    
    console.log('ì¹´í…Œê³ ë¦¬ ì‚­ì œ ì™„ë£Œ:', categoryName);
    deletingCategoryIndex = null;
  }

  // íƒ€ì„ë¼ì¸ì—ì„œ ì¹´í…Œê³ ë¦¬ í–‰ë“¤ ì‚­ì œ (ê°œì„ ëœ ë²„ì „)
  function deleteTimelineRowsForCategory(categoryIndex) {
    console.log('íƒ€ì„ë¼ì¸ ì¹´í…Œê³ ë¦¬ í–‰ ì‚­ì œ ì‹œì‘:', categoryIndex);
    
    // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    var categoryName = $('.category-header[data-category-index="' + categoryIndex + '"] .category-title').text().trim();
    console.log('ì‚­ì œí•  ì¹´í…Œê³ ë¦¬ ì´ë¦„:', categoryName);
    
    if (!categoryName) {
      console.log('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ - ì‚­ì œ ì¤‘ë‹¨');
      return;
    }
    
    // 1. í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  ì´ë²¤íŠ¸ í–‰ ì‚­ì œ
    var eventRows = $('.timeline-row[data-category-name="' + categoryName + '"]');
    console.log('ì‚­ì œí•  ì´ë²¤íŠ¸ í–‰ ìˆ˜:', eventRows.length);
    eventRows.remove();
    
    // 2. í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì¹´í…Œê³ ë¦¬ í–‰ ì‚­ì œ
    // ì¹´í…Œê³ ë¦¬ í–‰ì€ category-row í´ë˜ìŠ¤ë¥¼ ê°€ì§€ë©°, ìˆœì„œëŒ€ë¡œ ë°°ì¹˜ë˜ì–´ ìˆìŒ
    var categoryRowIndex = 0;
    $('.category-header').each(function(index) {
      if ($(this).data('category-index') == categoryIndex) {
        categoryRowIndex = index;
        return false; // break
      }
    });
    
    var categoryRow = $('.timeline-row.category-row').eq(categoryRowIndex);
    if (categoryRow.length > 0) {
      console.log('ì¹´í…Œê³ ë¦¬ í–‰ ì‚­ì œ:', categoryRowIndex);
      categoryRow.remove();
    } else {
      console.log('ì¹´í…Œê³ ë¦¬ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', categoryRowIndex);
    }
    
    // ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸
    setTimeout(function() {
      updateLineHeight();
    }, 50);
    
    console.log('íƒ€ì„ë¼ì¸ ì¹´í…Œê³ ë¦¬ í–‰ ì‚­ì œ ì™„ë£Œ');
  }

  

  // íƒ€ì„ë¼ì¸ í–‰ë“¤ ìˆ¨ê¸°ê¸° í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
  function hideTimelineRows(categoryIndex) {
    console.log('íƒ€ì„ë¼ì¸ í–‰ ìˆ¨ê¸°ê¸° ì‹œì‘:', categoryIndex);
    
    // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    var categoryName = $('.category-header[data-category-index="' + categoryIndex + '"] .category-title').text().trim();
    console.log('ì¹´í…Œê³ ë¦¬ ì´ë¦„:', categoryName);
    
    // ì¹´í…Œê³ ë¦¬ í–‰ì€ ìˆ¨ê¸°ì§€ ì•Šê³ , í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì´ë²¤íŠ¸ í–‰ë“¤ë§Œ ìˆ¨ê¸°ê¸°
    // (ì‚¬ì´ë“œë°”ì™€ ë™ì¼í•œ ë™ì‘: ì¹´í…Œê³ ë¦¬ í—¤ë”ëŠ” ë‚¨ì•„ìˆê³  ì´ë²¤íŠ¸ë“¤ë§Œ ìˆ¨ê¹€)
    $('.timeline-row[data-category-name="' + categoryName + '"]').addClass('hidden');
    console.log('ì¹´í…Œê³ ë¦¬', categoryName, 'ì˜ ëª¨ë“  ì´ë²¤íŠ¸ í–‰ ìˆ¨ê¹€ ì²˜ë¦¬ (ì¹´í…Œê³ ë¦¬ í–‰ì€ ìœ ì§€)');
    
    console.log('íƒ€ì„ë¼ì¸ í–‰ ìˆ¨ê¸°ê¸° ì™„ë£Œ');
  }

  // íƒ€ì„ë¼ì¸ í–‰ë“¤ í‘œì‹œ í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
  function showTimelineRows(categoryIndex) {
    console.log('íƒ€ì„ë¼ì¸ í–‰ í‘œì‹œ ì‹œì‘:', categoryIndex);
    
    // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    var categoryName = $('.category-header[data-category-index="' + categoryIndex + '"] .category-title').text().trim();
    console.log('ì¹´í…Œê³ ë¦¬ ì´ë¦„:', categoryName);
    
    // ì¹´í…Œê³ ë¦¬ í–‰ì€ í•­ìƒ í‘œì‹œë˜ì–´ ìˆìœ¼ë¯€ë¡œ, í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì´ë²¤íŠ¸ í–‰ë“¤ë§Œ í‘œì‹œ
    // (ì‚¬ì´ë“œë°”ì™€ ë™ì¼í•œ ë™ì‘: ì¹´í…Œê³ ë¦¬ í—¤ë”ëŠ” ê³„ì† ë³´ì´ê³  ì´ë²¤íŠ¸ë“¤ë§Œ ë‚˜íƒ€ë‚¨)
    $('.timeline-row[data-category-name="' + categoryName + '"]').removeClass('hidden');
    console.log('ì¹´í…Œê³ ë¦¬', categoryName, 'ì˜ ëª¨ë“  ì´ë²¤íŠ¸ í–‰ í‘œì‹œ ì²˜ë¦¬ (ì¹´í…Œê³ ë¦¬ í–‰ì€ í•­ìƒ í‘œì‹œë¨)');
    
    console.log('íƒ€ì„ë¼ì¸ í–‰ í‘œì‹œ ì™„ë£Œ');
  }

  // ìƒˆ ìŠ¤ì¼€ì¤„ ì¶”ê°€ í•¨ìˆ˜
  function addNewSchedule(scheduleInfo, scheduleData) {
    console.log('=== ìƒˆ ìŠ¤ì¼€ì¤„ ì¶”ê°€ ì‹œì‘ ===');
    console.log('ìŠ¤ì¼€ì¤„ ì •ë³´:', scheduleInfo);
    console.log('ìŠ¤ì¼€ì¤„ ë°ì´í„°:', scheduleData);
    
    var timelineRow = scheduleInfo.timelineRow;
    
    // ë‚ ì§œ ê³„ì‚° - ì¢…ë£Œì¼ ë¯¸í¬í•¨ ë°©ì‹
    var startDate = new Date(<%= start_date.to_time.to_i * 1000 %>);
    var projectStartDays = Math.round((scheduleData.start_date - startDate) / (1000 * 60 * 60 * 24));
    var projectDurationDays = Math.round((scheduleData.end_date - scheduleData.start_date) / (1000 * 60 * 60 * 24));  // ì¢…ë£Œì¼ ë¯¸í¬í•¨
    var barLeft = projectStartDays * <%= cell_width %>;
    var barWidth = projectDurationDays * <%= cell_width %>;
    var totalWidth = <%= total_width %>;
    
    console.log('ë‚ ì§œ ê³„ì‚° ê²°ê³¼:', {
      projectStartDays: projectStartDays,
      projectDurationDays: projectDurationDays,
      barLeft: barLeft,
      barWidth: barWidth
    });
    
    // í‘œì‹œ ë²”ìœ„ ë‚´ì— ìˆëŠ”ì§€ í™•ì¸
    if (barLeft >= -barWidth && barLeft <= totalWidth) {
      // ê¸°ì¡´ ìŠ¤ì¼€ì¤„ ë°”ë“¤ì˜ z-index í™•ì¸
      var existingBars = timelineRow.find('.project-bar');
      var maxZIndex = 100;
      existingBars.each(function() {
        var currentZIndex = parseInt($(this).css('z-index')) || 100;
        if (currentZIndex > maxZIndex) {
          maxZIndex = currentZIndex;
        }
      });
      var newZIndex = maxZIndex + 1;
      
      // ìƒ‰ìƒ í™•ì¸ (ê°œë³„ ìƒ‰ìƒ > ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ)
      var scheduleKey = scheduleInfo.eventName + '_' + existingBars.length;
      var scheduleColor = scheduleColors[scheduleKey];
      var categoryColor = getCategoryColor(scheduleInfo.categoryName);
      var appliedColor = scheduleColor || categoryColor;
      
      var barClass = appliedColor ? 'project-bar custom-color' : 'project-bar issue-' + scheduleData.issue;
      var barStyle = 'position: absolute; top: 2px; left: ' + Math.max(0, barLeft) + 'px; width: ' + Math.min(barWidth, totalWidth - Math.max(0, barLeft)) + 'px; z-index: ' + newZIndex + ';';
      
      if (appliedColor) {
        barStyle += ' background-color: ' + appliedColor + ';';
      }
      
      // ìƒˆ ìŠ¤ì¼€ì¤„ ë°” ìƒì„±
      var displayName = scheduleData.name.length > 20 ? scheduleData.name.substring(0, 20) + '...' : scheduleData.name;
      // done_ratioê°€ nullì´ ì•„ë‹ ê²½ìš° í¼ì„¼íŠ¸ ì¶”ê°€
      if (scheduleData.done_ratio !== null && scheduleData.done_ratio !== undefined) {
        displayName += ' (' + scheduleData.done_ratio + '%)';
      }
      
      // ì´ìŠˆ ë§í¬ ì•„ì´ì½˜ HTML (ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©)
      var issueLinkIcon = generateIssueLinkIcon(scheduleData.issue);
      
      var newScheduleBarHtml = '<div class="' + barClass + '" ' +
        'style="' + barStyle + '" ' +
        'title="' + scheduleData.name + ' (' + formatLocalDate(scheduleData.start_date) + ' ~ ' + formatLocalDate(scheduleData.end_date) + ')" ' +
        'data-schedule-index="' + (existingBars.length) + '" ' +
        'data-issue-number="' + scheduleData.issue + '" ' +
        'data-done-ratio="' + scheduleData.done_ratio + '">' +
        '<span class="project-bar-text">' + displayName.replace(/\n/g, '<br>') + '</span>' +
        issueLinkIcon +
        '</div>';
      
      // íƒ€ì„ë¼ì¸ í–‰ì— ì¶”ê°€
      timelineRow.append(newScheduleBarHtml);
      
      // ìƒˆë¡œ ì¶”ê°€ëœ ë°”ì— ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì ìš©
      var newBar = timelineRow.find('.project-bar').last();
      // ì›ë¬¸ ìŠ¤ì¼€ì¤„ëª…ì„ ë°ì´í„° ì†ì„±ìœ¼ë¡œ ë³´ì¡´
      newBar.attr('data-schedule-name', scheduleData.name);
      applyDraggableToElements(newBar);
      
      console.log('ìƒˆ ìŠ¤ì¼€ì¤„ ë°” ì¶”ê°€ë¨');
      
      
      // ì‚¬ì´ë“œë°”ì˜ ìŠ¤ì¼€ì¤„ ê°œìˆ˜ ì—…ë°ì´íŠ¸
      updateEventScheduleCount(scheduleInfo.eventName, scheduleInfo.categoryName);
      
    } else {
      console.log('ìŠ¤ì¼€ì¤„ì´ í‘œì‹œ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¨');
    }
    
    console.log('=== ìƒˆ ìŠ¤ì¼€ì¤„ ì¶”ê°€ ì™„ë£Œ ===');
  }

  // ì´ë²¤íŠ¸ì˜ ìŠ¤ì¼€ì¤„ ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateEventScheduleCount(eventName, categoryName) {
    console.log('ìŠ¤ì¼€ì¤„ ê°œìˆ˜ ì—…ë°ì´íŠ¸:', eventName, categoryName);
    
    // í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ì‚¬ì´ë“œë°” ì•„ì´í…œ ì°¾ê¸°
    $('.project-item').each(function() {
      var projectItem = $(this);
      var projectNameEl = projectItem.find('.project-name');
      var categoryIndex = projectItem.data('category-index');
      var categoryHeader = $('.category-header[data-category-index="' + categoryIndex + '"]');
      var currentCategoryName = categoryHeader.find('.category-title').text().trim();
      
      if (projectNameEl.text().trim() === eventName && currentCategoryName === categoryName) {
        // í•´ë‹¹ ì´ë²¤íŠ¸ì˜ íƒ€ì„ë¼ì¸ í–‰ ì°¾ê¸°
        var timelineRow = $('.timeline-row[data-event-name="' + eventName + '"][data-category-name="' + categoryName + '"]');
        var scheduleCount = timelineRow.find('.project-bar').length;
        
        // ìŠ¤ì¼€ì¤„ ì •ë³´ ì—…ë°ì´íŠ¸
        var projectInfo = projectItem.find('.project-info');
        projectInfo.text(scheduleCount + 'ê°œ ìŠ¤ì¼€ì¤„');
        
        console.log('ìŠ¤ì¼€ì¤„ ê°œìˆ˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', scheduleCount);
        return false; // ì°¾ì•˜ìœ¼ë¯€ë¡œ ë°˜ë³µ ì¢…ë£Œ
      }
    });
  }

  // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ë³µì› í•¨ìˆ˜ëŠ” ë” ì´ìƒ í•„ìš”í•˜ì§€ ì•ŠìŒ (ì„œë²„ì—ì„œ ì§ì ‘ ë Œë”ë§)

  // ì´ˆê¸° ë“œë˜ê·¸ ê¸°ëŠ¥ ì„¤ì •
  initializeProjectBarDraggable();
    
  // ì´ˆê¸° ë¼ì¸ ë†’ì´ ì„¤ì •
  setTimeout(function() {
    updateLineHeight();
  }, 100);

  // JSON ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#exportJsonBtn').click(function() {
    exportTimelineData( currentTimelineName );
  });

  // JSON ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#importJsonBtn').click(function() {
    $('#jsonFileInput').click();
  });

  // JSON ì„œë²„ ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#loadJsonBtn').click(function() {
    loadTimelineFromServer( currentTimelineName );
  });

  // JSON ì„œë²„ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#saveJsonBtn').click(function() {
    saveTimelineToServer( currentTimelineName  );
  });

  // XLSX ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#exportXlsxBtn').click(function() {
    exportTimelineToXlsx();
  });

  // PNG ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#exportPngBtn').click(function() {
    exportTimelineToPng();
  });

  // íŒŒì¼ ì„ íƒ ì‹œ JSON ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤í–‰
  $('#jsonFileInput').change(function(e) {
    var file = e.target.files[0];
    if (file) {
      importTimelineData(file);
    }
  });

  

  

  

   
   
   

  

  // ìŠ¤ì¼€ì¤„ ë°” ìš°í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  $(document).on('contextmenu', '.project-bar', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    var scheduleBar = $(this);
    var timelineRow = scheduleBar.closest('.timeline-row');
    var eventName = timelineRow.data('event-name');
    var categoryName = timelineRow.data('category-name');
    var scheduleName = scheduleBar.attr('data-schedule-name') || scheduleBar.find('.project-bar-text').text().trim();
    
    console.log('ìŠ¤ì¼€ì¤„ ë°” ìš°í´ë¦­:', {
      event: eventName,
      category: categoryName,
      schedule: scheduleName
    });
    
    // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ë°” ì •ë³´ ì €ì¥
    currentEditingScheduleBar = {
      element: scheduleBar,
      eventName: eventName,
      categoryName: categoryName,
      scheduleName: scheduleName,
      scheduleIndex: scheduleBar.data('schedule-index')
    };
    
    // íŒì—…ì— ì •ë³´ ì„¤ì •
    $('#scheduleEditEventName').text(eventName);
    $('#scheduleEditCategoryName').text('(' + categoryName + ')');
    $('#scheduleEditName').val(scheduleName);
    
    // ìŠ¤ì¼€ì¤„ ë°”ì˜ ìœ„ì¹˜ì™€ í¬ê¸°ë¡œë¶€í„° ë‚ ì§œ ì •ë³´ ê³„ì‚°
    var startDate = null;
    var endDate = null;
    
    // titleì—ì„œ ë‚ ì§œ ì •ë³´ ì¶”ì¶œ ì‹œë„
    var title = scheduleBar.attr('title') || '';
    var dateMatch = title.match(/\((\d{4}-\d{2}-\d{2}) ~ (\d{4}-\d{2}-\d{2})\)/);
    
    if (dateMatch) {
      startDate = dateMatch[1];
      endDate = dateMatch[2];
    } else {
      // titleì—ì„œ ë‚ ì§œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ ìœ„ì¹˜/í¬ê¸°ë¡œ ê³„ì‚°
      var barLeft = parseInt(scheduleBar.css('left')) || 0;
      var barWidth = scheduleBar.width() || <%= cell_width %>;
      var startDateObj = new Date(<%= start_date.to_time.to_i * 1000 %>);
      
      // ì‹œì‘ì¼ ê³„ì‚°
      var startDayOffset = Math.floor(barLeft / cellWidth);
      var calculatedStartDate = new Date(startDateObj.getTime() + (startDayOffset * 24 * 60 * 60 * 1000));
      
      // ì¢…ë£Œì¼ ê³„ì‚° (ì¢…ë£Œì¼ ë¯¸í¬í•¨ ë°©ì‹ìœ¼ë¡œ ì¼ê´€ì„± ìœ ì§€)
      var durationDays = Math.ceil(barWidth / cellWidth);
      var calculatedEndDate = new Date(calculatedStartDate.getTime() + (durationDays * 24 * 60 * 60 * 1000));
      
      startDate = formatLocalDate(calculatedStartDate);
      endDate = formatLocalDate(calculatedEndDate);
      
      console.log('ìœ„ì¹˜ë¡œë¶€í„° ê³„ì‚°ëœ ë‚ ì§œ:', {
        barLeft: barLeft,
        barWidth: barWidth,
        startDate: startDate,
        endDate: endDate
      });
    }
    
    $('#scheduleEditStartDate').val(startDate);
    $('#scheduleEditEndDate').val(endDate);
    
    // ì´ìŠˆ ì •ë³´ ì¶”ì¶œ
    var issueNumber = scheduleBar.attr('data-issue-number') || '';
    var doneRatio = scheduleBar.attr('data-done-ratio') || null;
    $('#scheduleEditIssue').val(issueNumber);
    
    // í˜„ì¬ ìŠ¤ì¼€ì¤„ì˜ ìƒ‰ìƒ ì •ë³´ ë¡œë“œ
    var scheduleKey = eventName + '_' + currentEditingScheduleBar.scheduleIndex;
    var currentScheduleColor = scheduleColors[scheduleKey] || null;
    
    // ìƒ‰ìƒ ì„ íƒ UI ì´ˆê¸°í™”
    initializeScheduleColorPicker(currentScheduleColor, categoryName);
    
    // íŒì—… í‘œì‹œ
    $('#scheduleEditPopup').addClass('show');
    
    // í¬ì»¤ìŠ¤ ì„¤ì •
    setTimeout(function() {
      $('#scheduleEditName').focus().select();
    }, 100);
  });

  // ìŠ¤ì¼€ì¤„ í¸ì§‘ íŒì—… ì·¨ì†Œ ë²„íŠ¼
  $('#scheduleEditCancelBtn').click(function(e) {
    e.preventDefault();
    hideScheduleEditPopup();
  });

  // ìŠ¤ì¼€ì¤„ í¸ì§‘ íŒì—… ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
  $('#scheduleEditPopup').click(function(e) {
    if (e.target === this) {
      hideScheduleEditPopup();
    }
  });

  // ìŠ¤ì¼€ì¤„ í¸ì§‘ íŒì—… ìˆ¨ê¸°ê¸° í•¨ìˆ˜
  function hideScheduleEditPopup() {
    $('#scheduleEditPopup').removeClass('show');
    currentEditingScheduleBar = null;
  }

  // ìŠ¤ì¼€ì¤„ í¸ì§‘ í¼ ì œì¶œ ì²˜ë¦¬
  $('#scheduleEditForm').submit(function(e) {
    e.preventDefault();
    
    if (!currentEditingScheduleBar) {
      console.error('í¸ì§‘ ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    var newScheduleName = $('#scheduleEditName').val().trim();
    var newStartDate = $('#scheduleEditStartDate').val();
    var newEndDate = $('#scheduleEditEndDate').val();
    var newIssueNumber = $('#scheduleEditIssue').val();
    var newColor = rgbToHex($('#scheduleColorPreview').css('background-color'));
    
    if (!newScheduleName || !newStartDate || !newEndDate) {
      alert('ì¼ì •ëª…, ì‹œì‘ì¼, ì¢…ë£Œì¼ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
      return;
    }
    
    // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
    if (new Date(newStartDate) > new Date(newEndDate)) {
      alert('ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    // ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì •ë³´ ì €ì¥
    var scheduleKey = currentEditingScheduleBar.eventName + '_' + currentEditingScheduleBar.scheduleIndex;
    var categoryColor = getCategoryColor(currentEditingScheduleBar.categoryName);
    
    // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒê³¼ ê°™ìœ¼ë©´ ê°œë³„ ìƒ‰ìƒ ì œê±°
    if (newColor === categoryColor) {
      delete scheduleColors[scheduleKey];
    } else {
      scheduleColors[scheduleKey] = newColor;
    }
    
    console.log('ìŠ¤ì¼€ì¤„ í¸ì§‘ ì €ì¥:', {
      name: newScheduleName,
      startDate: newStartDate,
      endDate: newEndDate,
      issue: newIssueNumber,
      color: newColor
    });
    
    // ìŠ¤ì¼€ì¤„ ë°” ì—…ë°ì´íŠ¸
    updateScheduleBar(currentEditingScheduleBar.element, {
      name: newScheduleName,
      start_date: parseLocalDate(newStartDate),
      end_date: parseLocalDate(newEndDate),
      issue: newIssueNumber,
      color: newColor
    });
    
    // íŒì—… ë‹«ê¸°
    hideScheduleEditPopup();
  });

  // ìŠ¤ì¼€ì¤„ ì‚­ì œ ë²„íŠ¼
  $('#scheduleEditDeleteBtn').click(function(e) {
    e.preventDefault();
    
    if (!currentEditingScheduleBar) {
      console.error('í¸ì§‘ ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    var scheduleName = currentEditingScheduleBar.scheduleName;
    var eventName = currentEditingScheduleBar.eventName;
    
    if (confirm('ì •ë§ë¡œ "' + scheduleName + '" ìŠ¤ì¼€ì¤„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      console.log('ìŠ¤ì¼€ì¤„ ì‚­ì œ:', scheduleName);
      
      // ìŠ¤ì¼€ì¤„ ë°” ì œê±°
      currentEditingScheduleBar.element.remove();
      
      // ì‚¬ì´ë“œë°” í”„ë¡œì íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
      updateProjectInfo(eventName, currentEditingScheduleBar.categoryName);
      
      // íŒì—… ë‹«ê¸°
      hideScheduleEditPopup();
    }
  });

  

  // ì´ë²¤íŠ¸ í¸ì§‘ ëª¨ë“œ ì§„ì…
  function enterEventEditMode(eventItem) {
    console.log('ì´ë²¤íŠ¸ í¸ì§‘ ëª¨ë“œ ì§„ì…');
    eventItem.addClass('editing');
    
    // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
    setTimeout(function() {
      eventItem.find('.event-edit-input').focus().select();
    }, 100);
  }

  // ì´ë²¤íŠ¸ í¸ì§‘ ì €ì¥
  function saveEvent(eventItem) {
    console.log('ì´ë²¤íŠ¸ í¸ì§‘ ì €ì¥');
    
    var newName = eventItem.find('.event-edit-input').val().trim();
    var oldName = eventItem.find('.project-name').text().trim();
    
    if (!newName) {
      alert('ì´ë²¤íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      eventItem.find('.event-edit-input').focus();
      return;
    }
    
    if (newName === oldName) {
      cancelEventEditMode(eventItem);
      return;
    }
    
    // ì‚¬ì´ë“œë°”ì—ì„œ ì´ë²¤íŠ¸ ì´ë¦„ ì—…ë°ì´íŠ¸
    eventItem.find('.project-name').html(newName.replace(/\n/g, '<br>'));
    
    // íƒ€ì„ë¼ì¸ì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ì˜ data-event-name ì—…ë°ì´íŠ¸
    var categoryIndex = eventItem.data('category-index');
    var categoryHeader = $('.category-header[data-category-index="' + categoryIndex + '"]');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    
    var timelineRow = $('.timeline-row[data-event-name="' + oldName + '"][data-category-name="' + categoryName + '"]');
    if (timelineRow.length > 0) {
      timelineRow.attr('data-event-name', newName);
      console.log('íƒ€ì„ë¼ì¸ í–‰ì˜ data-event-name ì—…ë°ì´íŠ¸:', oldName, '->', newName);
    }
    
    eventItem.removeClass('editing');
    console.log('ì´ë²¤íŠ¸ ì´ë¦„ ë³€ê²½ ì™„ë£Œ:', oldName, '->', newName);
  }

  // ì´ë²¤íŠ¸ í¸ì§‘ ëª¨ë“œ ì·¨ì†Œ
  function cancelEventEditMode(eventItem) {
    console.log('ì´ë²¤íŠ¸ í¸ì§‘ ëª¨ë“œ ì·¨ì†Œ');
    eventItem.removeClass('editing');
    
    var originalName = eventItem.find('.project-name').text();
    eventItem.find('.event-edit-input').val(originalName);
  }

  // ì´ë²¤íŠ¸ ì‚­ì œ
  function deleteEvent(eventItem) {
    console.log('ì´ë²¤íŠ¸ ì‚­ì œ ì‹œì‘');
    
    var eventName = eventItem.find('.project-name').text().trim();
    var categoryIndex = eventItem.data('category-index');
    var categoryHeader = $('.category-header[data-category-index="' + categoryIndex + '"]');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    
    console.log('ì‚­ì œí•  ì´ë²¤íŠ¸:', eventName, 'ì¹´í…Œê³ ë¦¬:', categoryName);
    
    // 2. íƒ€ì„ë¼ì¸ì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ í–‰ ì‚­ì œ
    var timelineRow = $('.timeline-row[data-event-name="' + eventName + '"][data-category-name="' + categoryName + '"]');
    if (timelineRow.length > 0) {
      timelineRow.remove();
      console.log('íƒ€ì„ë¼ì¸ í–‰ ì‚­ì œë¨');
    }
    
    // 3. ì‚¬ì´ë“œë°”ì—ì„œ ì´ë²¤íŠ¸ ì•„ì´í…œ ì‚­ì œ
    eventItem.remove();
    
    console.log('ì´ë²¤íŠ¸ ì‚­ì œ ì™„ë£Œ:', eventName);
  }
  
  
  // ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì„ íƒ UI ì´ˆê¸°í™” í•¨ìˆ˜
  function initializeScheduleColorPicker(currentColor, categoryName) {
    var displayColor = currentColor;
    if (!displayColor) {
      // ìƒ‰ìƒì´ ì—†ìœ¼ë©´ ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒìœ¼ë¡œ ì´ˆê¸°í™”
      var categoryColor = getCategoryColor(categoryName);
      displayColor = categoryColor || '#6c757d';
    }
    
    // ìƒ‰ìƒ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    $('#scheduleColorPreview').css('background-color', displayColor);
  }
  
  // ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì„ íƒ ë²„íŠ¼ í´ë¦­
  $('#scheduleColorSelectBtn, #scheduleColorPreview').click(function(e) {
    e.preventDefault();
    
    if (!currentEditingScheduleBar) return;
    
    // í˜„ì¬ ìŠ¤ì¼€ì¤„ì˜ ìƒ‰ìƒ ì •ë³´
    var scheduleKey = currentEditingScheduleBar.eventName + '_' + currentEditingScheduleBar.scheduleIndex;
    var currentColor = scheduleColors[scheduleKey] || getCategoryColor(currentEditingScheduleBar.categoryName) || '#6c757d';
    
    // í˜„ì¬ ìƒ‰ìƒ ë³€ê²½ ì¤‘ì¸ ëŒ€ìƒ ì •ë³´ ì €ì¥
    currentColorEditingTarget = {
      type: 'schedule',
      scheduleKey: scheduleKey,
      categoryName: currentEditingScheduleBar.categoryName,
      eventName: currentEditingScheduleBar.eventName,
      scheduleIndex: currentEditingScheduleBar.scheduleIndex
    };
    
    // íŒì—… íƒ€ì´í‹€ê³¼ ëŒ€ìƒ ì´ë¦„ ì„¤ì •
    $('#colorPickerTitle').text('ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì„ íƒ');
    $('#colorPickerTargetName').text(currentEditingScheduleBar.scheduleName);
    
    // í˜„ì¬ ìƒ‰ìƒ ì„¤ì •
    selectedColor = currentColor;
    updateColorSelection(currentColor);
    
    // íŒì—… í‘œì‹œ
    $('#colorPickerPopup').addClass('show');
  });
  
  // ìƒ‰ìƒ ì´ˆê¸°í™” ë²„íŠ¼
  $('#resetScheduleColorBtn').click(function(e) {
    e.preventDefault();
    
    if (!currentEditingScheduleBar) return;
    
    var categoryColor = getCategoryColor(currentEditingScheduleBar.categoryName) || '#6c757d';
    
    // ìƒ‰ìƒ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    $('#scheduleColorPreview').css('background-color', categoryColor);
    
    // ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì •ë³´ ì œê±°
    var scheduleKey = currentEditingScheduleBar.eventName + '_' + currentEditingScheduleBar.scheduleIndex;
    delete scheduleColors[scheduleKey];
  });

  // ì´ìŠˆ ë§í¬ ì•„ì´ì½˜ í´ë¦­ ì´ë²¤íŠ¸ (ë“œë˜ê·¸ ë°©í•´ ë°©ì§€)
  $(document).on('click', '.issue-link-icon', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    var issueNumber = $(this).closest('.project-bar').attr('data-issue-number');
    if (issueNumber) {
      var issueUrl = '/issues/' + issueNumber;
      window.open(issueUrl, '_blank');
    }
  });

  // ì´ìŠˆ ë§í¬ ì•„ì´ì½˜ì—ì„œ ë“œë˜ê·¸ ì‹œì‘ ë°©ì§€
  $(document).on('mousedown', '.issue-link-icon', function(e) {
    e.stopPropagation();
  });

  

  // ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  ì´ë²¤íŠ¸ ìŠ¤ì¼€ì¤„ ë°” ìƒ‰ìƒ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateCategoryScheduleColors(categoryName, color) {
    console.log('ì¹´í…Œê³ ë¦¬ ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì—…ë°ì´íŠ¸:', categoryName, color);
    
    // ë§¤ê°œë³€ìˆ˜ ê²€ì¦
    if (!categoryName || typeof categoryName !== 'string') {
      console.error('âŒ ì˜ëª»ëœ ì¹´í…Œê³ ë¦¬ ì´ë¦„:', categoryName);
      return;
    }
    
    if (!color || typeof color !== 'string') {
      console.error('âŒ ì˜ëª»ëœ ìƒ‰ìƒ ê°’:', color);
      return;
    }
    
    // categoryColors ê°ì²´ ì•ˆì „ì„± í™•ì¸
    if (typeof categoryColors === 'undefined' || categoryColors === null) {
      console.warn('âš ï¸ categoryColors ê°ì²´ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ - ì´ˆê¸°í™” ì§„í–‰');
      categoryColors = {};
    }
    
    // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  íƒ€ì„ë¼ì¸ í–‰ ì°¾ê¸°
    var timelineRows = $('.timeline-row[data-category-name="' + categoryName + '"]');
    console.log('ì—…ë°ì´íŠ¸í•  íƒ€ì„ë¼ì¸ í–‰ ê°œìˆ˜:', timelineRows.length);
    
    timelineRows.each(function() {
      var timelineRow = $(this);
      var eventName = timelineRow.data('event-name');
      
      // í•´ë‹¹ í–‰ì˜ ëª¨ë“  ìŠ¤ì¼€ì¤„ ë°” ì°¾ê¸°
      var scheduleBars = timelineRow.find('.project-bar');
      console.log('ì´ë²¤íŠ¸ "' + eventName + '"ì˜ ìŠ¤ì¼€ì¤„ ë°” ê°œìˆ˜:', scheduleBars.length);
      
      // ê° ìŠ¤ì¼€ì¤„ ë°”ì˜ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
      scheduleBars.each(function(scheduleIndex) {
        var $bar = $(this);
        
        // ê°œë³„ ìŠ¤ì¼€ì¤„ ìƒ‰ìƒì´ ì§€ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        var scheduleKey = eventName + '_' + scheduleIndex;
        var hasCustomScheduleColor = scheduleColors[scheduleKey] !== undefined;
        
        // ê°œë³„ ìƒ‰ìƒì´ ì§€ì •ëœ ê²½ìš° ìŠ¤í‚µ
        if (hasCustomScheduleColor) {
          console.log('ìŠ¤ì¼€ì¤„ ë°” ê°œë³„ ìƒ‰ìƒ ìœ ì§€:', $bar.text().trim(), '->', scheduleColors[scheduleKey]);
          return; // continue to next schedule bar
        }
        
        // ê¸°ì¡´ ìƒíƒœ í´ë˜ìŠ¤ ì œê±°
        $bar.removeClass(function(index, className) {
          return (className.match(/issue-\S+/g) || []).join(' ');
        });
        
        // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì ìš©
        $bar.css('background-color', color);
        $bar.addClass('custom-color');
        
        console.log('ìŠ¤ì¼€ì¤„ ë°” ìƒ‰ìƒ ì—…ë°ì´íŠ¸:', $bar.text().trim(), '->', color);
      });
    });
  }

  // ESC í‚¤ë¡œ íŒì—… ë‹«ê¸° (ëª¨ë“  í•¨ìˆ˜ ì •ì˜ í›„ì— ë°°ì¹˜)
  $(document).keydown(function(e) {
    if (e.key === 'Escape') {
      if ($('#scheduleEditPopup').hasClass('show')) {
        hideScheduleEditPopup();
      } else if ($('#schedulePopup').hasClass('show')) {
        hideSchedulePopup();
      } else if ($('#eventPopup').hasClass('show')) {
        hideEventPopup();
      } else if ($('#colorPickerPopup').hasClass('show')) {
        hideColorPickerPopup();
      }
    }
  });

});
</script>


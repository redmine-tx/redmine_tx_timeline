<script>

// ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ í•¨ìˆ˜
  function addNewCategory(categoryName) {
    console.log('ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€:', categoryName);
    
    // ìƒˆ ì¹´í…Œê³ ë¦¬ ì¸ë±ìŠ¤ ê³„ì‚°
    var maxIndex = -1;
    $('.category-header').each(function() {
      var index = $(this).data('category-index');
      if (index > maxIndex) maxIndex = index;
    });
    var newCategoryIndex = maxIndex + 1;
    categoryColors[categoryName] = '#6c757d';
    
    // ì‚¬ì´ë“œë°”ì— ìƒˆ ì¹´í…Œê³ ë¦¬ í—¤ë” ì¶”ê°€
    var newCategoryHtml = '<div class="category-header" data-category-index="' + newCategoryIndex + '">' +
      '<div class="category-left">' +
        '<button class="category-toggle-btn" type="button">â–¼</button>' +
        '<span class="category-title">' + categoryName + '</span>' +
      '</div>' +
      '<div class="category-actions">' +
        '<button class="category-btn add-event-btn" type="button" title="ì´ë²¤íŠ¸ ì¶”ê°€">+</button>' +
        '<button class="category-btn edit-category-btn" type="button" title="ì´ë¦„ ë³€ê²½">âœ</button>' +
        '<button class="category-btn color-category-btn" type="button" title="ìƒ‰ìƒ ë³€ê²½">ğŸ¨</button>' +
        '<button class="category-btn delete-category-btn" type="button" title="ì¹´í…Œê³ ë¦¬ ì‚­ì œ">Ã—</button>' +
      '</div>' +
          '</div>';
      
      $('.sidebar-content').append(newCategoryHtml);
    
    // íƒ€ì„ë¼ì¸ì— ìƒˆ ì¹´í…Œê³ ë¦¬ í–‰ ì¶”ê°€
    var cellsHtml = '';
    <% days.each do |day| %>
      cellsHtml += '<div class="timeline-cell" style="width: <%= cell_width %>px;"></div>';
    <% end %>
    
    var newTimelineRowHtml = '<div class="timeline-row category-row" data-category-name="' + categoryName + '">' +
      '<div class="timeline-grid">' + cellsHtml + '</div>' +
      '</div>';
    
    $('.timeline-body').append(newTimelineRowHtml);
    
    // ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸
    setTimeout(function() {
      updateLineHeight();
    }, 50);
    
    console.log('ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì™„ë£Œ:', categoryName, 'ê¸°ë³¸ ìƒ‰ìƒ:', categoryColors[categoryName]);
  }

  // ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ í•¨ìˆ˜ (ê°œë³„ í–‰ ì¶”ê°€ ë°©ì‹)
  function addNewEvent(categoryIndex, eventData) {
    console.log('=== ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ ì‹œì‘ ===');
    console.log('ì¹´í…Œê³ ë¦¬ ì¸ë±ìŠ¤:', categoryIndex);
    console.log('ì´ë²¤íŠ¸ ë°ì´í„°:', eventData);
    
    // 1. ì‚¬ì´ë“œë°”ì— í”„ë¡œì íŠ¸ ì•„ì´í…œ ì¶”ê°€
    var categoryProjects = $('.project-item[data-category-index="' + categoryIndex + '"]');
    var categoryHeader = $('.category-header[data-category-index="' + categoryIndex + '"]');
    
    var newProjectHtml = '<div class="project-item" data-category-index="' + categoryIndex + '">' +
      '<div class="event-content">' +
        '<div class="project-name">' + eventData.name.replace(/\n/g, '<br>') + '</div>' +
        '<div class="project-info">0ê°œ ì´ë²¤íŠ¸</div>' +
      '</div>' +
      '<form class="event-edit-form">' +
        '<textarea class="event-edit-input">' + eventData.name + '</textarea>' +
      '</form>' +
      '<div class="event-actions">' +
        '<button class="event-btn edit-event-btn" title="í¸ì§‘">âœï¸</button>' +
        '<button class="event-btn delete-event-btn" title="ì‚­ì œ">ğŸ—‘ï¸</button>' +
      '</div>' +
      '<div class="event-edit-actions">' +
        '<button class="event-btn save-event-btn" title="ì €ì¥">âœ“</button>' +
        '<button class="event-btn cancel-event-btn" title="ì·¨ì†Œ">âœ•</button>' +
      '</div>' +
    '</div>';
    
    var newProjectElement;
    if (categoryProjects.length > 0) {
      categoryProjects.last().after(newProjectHtml);
      newProjectElement = categoryProjects.last().next();
      console.log('ê¸°ì¡´ í”„ë¡œì íŠ¸ ë’¤ì— ì¶”ê°€');
    } else {
      categoryHeader.after(newProjectHtml);
      newProjectElement = categoryHeader.next();
      console.log('ì¹´í…Œê³ ë¦¬ í—¤ë” ë’¤ì— ì¶”ê°€');
    }
    
    // 2. íƒ€ì„ë¼ì¸ì— í•´ë‹¹ í–‰ë§Œ ì¶”ê°€ (ê¸°ì¡´ í–‰ë“¤ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
    var cellsHtml = '';
    <% days.each_with_index do |day, index| %>
      cellsHtml += '<div class="timeline-cell schedule-add-target" style="width: <%= cell_width %>px;" data-date="<%= day[:date].strftime('%Y-%m-%d') %>"></div>';
    <% end %>
    
    var categoryName = $('.category-header[data-category-index="' + categoryIndex + '"] .category-title').text().trim();
    
    var newTimelineRowHtml = '<div class="timeline-row" data-event-name="' + eventData.name + '" data-category-name="' + categoryName + '">' +
      '<div class="timeline-grid">' + cellsHtml + '</div>' +
      '</div>';
    
    // íƒ€ì„ë¼ì¸ì—ì„œ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ ì°¾ê¸°
    var timelineInsertPosition = findTimelineInsertPosition(categoryIndex, newProjectElement);
    var newTimelineRow;
    if (timelineInsertPosition.method === 'after') {
      timelineInsertPosition.element.after(newTimelineRowHtml);
      newTimelineRow = timelineInsertPosition.element.next();
    } else {
      timelineInsertPosition.element.before(newTimelineRowHtml);
      newTimelineRow = timelineInsertPosition.element.prev();
    }
    
    // ìƒˆë¡œ ì¶”ê°€ëœ í–‰ì˜ í”„ë¡œì íŠ¸ ë°”ë“¤ì— ëŒ€í•´ ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì ìš©
    initializeProjectBarDraggableForRow(newTimelineRow);
    
    // ì¹´í…Œê³ ë¦¬ê°€ ì ‘íŒ ìƒíƒœì¸ì§€ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ìˆ¨ê¸°ê¸°
    var categoryHeader = $('.category-header[data-category-index="' + categoryIndex + '"]');
    if (categoryHeader.hasClass('category-collapsed')) {
      console.log('ì ‘íŒ ì¹´í…Œê³ ë¦¬ì— ì´ë²¤íŠ¸ ì¶”ê°€ë¨ - ìë™ìœ¼ë¡œ ìˆ¨ê¸°ê¸°');
      newProjectElement.addClass('hidden');
      newTimelineRow.addClass('hidden');
    }
    
    // ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸
    setTimeout(function() {
      updateLineHeight();
    }, 50);
    
    console.log('=== ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ ì™„ë£Œ ===');
  }

    // íƒ€ì„ë¼ì¸ ì‚½ì… ìœ„ì¹˜ ì°¾ê¸° í•¨ìˆ˜
  function findTimelineInsertPosition(categoryIndex, newSidebarElement) {
    var timelineRows = $('.timeline-row');
    var sidebarElements = $('.sidebar-content').children();
    var sidebarIndex = sidebarElements.index(newSidebarElement);
    var timelineIndex = 0;
    
    // ì‚¬ì´ë“œë°” ìˆœì„œì— ë§ëŠ” íƒ€ì„ë¼ì¸ ìœ„ì¹˜ ê³„ì‚°
    for (var i = 0; i < sidebarIndex; i++) {
        var element = sidebarElements.eq(i);
        if (element.hasClass('category-header') || element.hasClass('project-item')) {
            timelineIndex++;
        }
    }
    
    if (timelineIndex === 0) {
        // ì²« ë²ˆì§¸ ìœ„ì¹˜ì— ì‚½ì…
        return {
            method: 'before',
            element: timelineRows.first()
        };
    } else if (timelineIndex >= timelineRows.length) {
        // ë§ˆì§€ë§‰ ìœ„ì¹˜ì— ì‚½ì…
        return {
            method: 'after',
            element: timelineRows.last()
        };
    } else {
        // ì¤‘ê°„ ìœ„ì¹˜ì— ì‚½ì…
        return {
            method: 'before',
            element: timelineRows.eq(timelineIndex)
        };
    }
  }

  // ì´ë²¤íŠ¸ íŒì—… ìˆ¨ê¸°ê¸° í•¨ìˆ˜
  function hideEventPopup() {
    $('#eventPopup').removeClass('show');
    currentEditingCategory = null;
  }

  // ìŠ¤ì¼€ì¤„ íŒì—… ìˆ¨ê¸°ê¸° í•¨ìˆ˜
  function hideSchedulePopup() {
    $('#schedulePopup').removeClass('show');
    currentEditingSchedule = null;
  }

  
  // ìƒ‰ìƒ ì„ íƒ íŒì—… ìˆ¨ê¸°ê¸° í•¨ìˆ˜
  function hideColorPickerPopup() {
    $('#colorPickerPopup').removeClass('show');
    currentColorEditingTarget = null;
    selectedColor = '#6c757d';
  }
  
  // ìƒ‰ìƒ ì„ íƒ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateColorSelection(color) {
    // ëª¨ë“  ìƒ‰ìƒ ì•„ì´í…œì—ì„œ ì„ íƒ í•´ì œ
    $('.color-preset-item').removeClass('selected');
    
    // í•´ë‹¹í•˜ëŠ” ìƒ‰ìƒ ì•„ì´í…œì— ì„ íƒ í‘œì‹œ
    $('.color-preset-item[data-color="' + color + '"]').addClass('selected');
    
    // ë¯¸ë¦¬ë³´ê¸° ë°” ìƒ‰ìƒ ì—…ë°ì´íŠ¸
    $('#colorPreviewBar').css('background-color', color);
    
    // ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
    $('#customColorPicker').val(color);
  }

  </script>
<script>

// ì¹´í…Œê³ ë¦¬ì˜ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ (ì•ˆì „í•œ ì ‘ê·¼)
function getCategoryColor(categoryName) {
  if (!categoryName || typeof categoryName !== 'string') {
    return null;
  }
  
  // categoryColors ê°ì²´ê°€ ì•ˆì „í•˜ê²Œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
  if (typeof categoryColors === 'undefined' || categoryColors === null) {
    console.warn('âš ï¸ categoryColors ê°ì²´ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
    categoryColors = {};
    return null;
  }
  
  return categoryColors[categoryName] || null;
}

// ì‚¬ì´ë“œë°” í”„ë¡œì íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸ (ìŠ¤ì¼€ì¤„ ê°œìˆ˜ë§Œ í‘œì‹œ)
  function updateSidebarProjectInfo($projectBar, dates) {
    var projectName = $projectBar.text().trim();
    
    // ì‚¬ì´ë“œë°”ì—ì„œ í•´ë‹¹ í”„ë¡œì íŠ¸ ì°¾ê¸°
    $('.project-item').each(function() {
      if ($(this).find('.project-name').text().trim() === projectName) {
        // í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ìŠ¤ì¼€ì¤„ ê°œìˆ˜ ê³„ì‚°
        var categoryIndex = $(this).data('category-index');
        var categoryHeader = $('.category-header[data-category-index="' + categoryIndex + '"]');
        var categoryName = categoryHeader.find('.category-title').text().trim();
        var timelineRow = $('.timeline-row[data-event-name="' + projectName + '"][data-category-name="' + categoryName + '"]');
        var scheduleCount = timelineRow.find('.project-bar').length;
        
        $(this).find('.project-info').text(scheduleCount + 'ê°œ ìŠ¤ì¼€ì¤„');
        return false; // ì°¾ì•˜ìœ¼ë©´ ë°˜ë³µ ì¤‘ë‹¨
      }
    });
  }

  // í”„ë¡œì íŠ¸ ë‚ ì§œ ê³„ì‚° í•¨ìˆ˜ (ë“œë˜ê·¸ìš©)
  function calculateProjectDates($projectBar, leftPosition) {
    var startDate = new Date(<%= start_date.to_time.to_i * 1000 %>);
    var daysOffset = Math.floor(leftPosition / cellWidth); // ë°”ë‹¥í•¨ìˆ˜ë¡œ ì…€ ì‹œì‘ì  ê¸°ì¤€ ê³„ì‚°
    
    // ì‹œì‘ì¼ ê³„ì‚°
    var projectStartDate = new Date(startDate.getTime() + (daysOffset * 24 * 60 * 60 * 1000));
    
    // í”„ë¡œì íŠ¸ ê¸°ê°„ ê³„ì‚° (ë°”ì˜ ë„ˆë¹„ ê¸°ì¤€)
    var durationDays = Math.round($projectBar.width() / cellWidth); // ë„ˆë¹„ëŠ” ë°˜ì˜¬ë¦¼ ì‚¬ìš©
    var projectEndDate = new Date(projectStartDate.getTime() + (durationDays * 24 * 60 * 60 * 1000));  // ì¢…ë£Œì¼ ë¯¸í¬í•¨ ë°©ì‹
    
    return {
      startDate: projectStartDate,
      endDate: projectEndDate
    };
  }

  // í”„ë¡œì íŠ¸ ë‚ ì§œ ê³„ì‚° í•¨ìˆ˜ (ë¦¬ì‚¬ì´ì¦ˆìš©)
  function calculateProjectDatesFromResize($projectBar, leftPosition, width) {
    var startDate = new Date(<%= start_date.to_time.to_i * 1000 %>);
    var daysOffset = Math.floor(leftPosition / cellWidth); // ë°”ë‹¥í•¨ìˆ˜ë¡œ ì…€ ì‹œì‘ì  ê¸°ì¤€ ê³„ì‚°
    
    // ì‹œì‘ì¼ ê³„ì‚°
    var projectStartDate = new Date(startDate.getTime() + (daysOffset * 24 * 60 * 60 * 1000));
    
    // í”„ë¡œì íŠ¸ ê¸°ê°„ ê³„ì‚° (ë¦¬ì‚¬ì´ì¦ˆëœ ë„ˆë¹„ ê¸°ì¤€)
    var durationDays = Math.round(width / cellWidth); // ë„ˆë¹„ëŠ” ë°˜ì˜¬ë¦¼ ì‚¬ìš©
    var projectEndDate = new Date(projectStartDate.getTime() + (durationDays * 24 * 60 * 60 * 1000));  // ì¢…ë£Œì¼ ë¯¸í¬í•¨ ë°©ì‹

    return {
      startDate: projectStartDate,
      endDate: projectEndDate
    };
  }

// ë“œë˜ê·¸ ì¤‘ ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateProjectDates($projectBar, leftPosition) {
  var dates = calculateProjectDates($projectBar, leftPosition);
  
  // í˜„ì§€ ì‹œê°„ëŒ€ ê¸°ì¤€ìœ¼ë¡œ YYYY-MM-DD í˜•ì‹ ë³€í™˜
  var startDateStr = formatLocalDate(dates.startDate);
  var endDateStr = formatLocalDate(dates.endDate);
  
  $projectBar.attr('title', 
    $projectBar.text() + ' (' + startDateStr + ' ~ ' + endDateStr + ')'
  );
}

// ë¦¬ì‚¬ì´ì¦ˆ ì¤‘ ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateProjectDatesFromResize($projectBar, leftPosition, width) {
  var dates = calculateProjectDatesFromResize($projectBar, leftPosition, width);
  
  // í˜„ì§€ ì‹œê°„ëŒ€ ê¸°ì¤€ìœ¼ë¡œ YYYY-MM-DD í˜•ì‹ ë³€í™˜
  var startDateStr = formatLocalDate(dates.startDate);
  var endDateStr = formatLocalDate(dates.endDate);
  
  $projectBar.attr('title', 
    $projectBar.text() + ' (' + startDateStr + ' ~ ' + endDateStr + ')'
  );
}

// ë‚ ì§œë¥¼ í˜„ì§€ ì‹œê°„ëŒ€ ê¸°ì¤€ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
function formatLocalDate(date) {
  var year = date.getFullYear();
  var month = ('0' + (date.getMonth() + 1)).slice(-2);
  var day = ('0' + date.getDate()).slice(-2);
  return year + '-' + month + '-' + day;
}

// YYYY-MM-DD ë¬¸ìì—´ì„ í˜„ì§€ ì‹œê°„ëŒ€ ê¸°ì¤€ Date ê°ì²´ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
function parseLocalDate(dateString) {
  var parts = dateString.split('-');
  if (parts.length !== 3) {
    return new Date(dateString); // fallback
  }
  // í˜„ì§€ ì‹œê°„ëŒ€ë¡œ íŒŒì‹± (UTCê°€ ì•„ë‹Œ)
  return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
}

// ëª¨ë“  íƒ€ì„ë¼ì¸ ë°ì´í„° ì‚­ì œ í•¨ìˆ˜
  function clearAllTimelineData() {
    console.log('ê¸°ì¡´ íƒ€ì„ë¼ì¸ ë°ì´í„° ì‚­ì œ ì‹œì‘');
    
    // íƒ€ì„ë¼ì¸ í–‰ë“¤ ì‚­ì œ (ì˜¤ëŠ˜ í‘œì‹œì„  ì œì™¸)
    $('.timeline-row').remove();
    
    // ì‚¬ì´ë“œë°” ì¹´í…Œê³ ë¦¬ì™€ í”„ë¡œì íŠ¸ ì‚­ì œ
    $('.category-header, .project-item').remove();
    
    console.log('ê¸°ì¡´ íƒ€ì„ë¼ì¸ ë°ì´í„° ì‚­ì œ ì™„ë£Œ');
  }

  // ë¶ˆëŸ¬ì˜¨ ë°ì´í„° ì ìš© í•¨ìˆ˜
  function applyImportedData(importData) {
    console.log('ë¶ˆëŸ¬ì˜¨ ë°ì´í„° ì ìš© ì‹œì‘');

    // ì»¬ëŸ¬ ì •ë³´ ì´ˆê¸°í™”
    categoryColors = {};
    scheduleColors = {};    
    currentTimelineName = importData.metadata.name;

    // ì»¬ëŸ¬ ì •ë³´ ë³µì›
    importData.categories.forEach(function(categoryData, categoryIndex) {
      // ì¹´í…Œê³ ë¦¬ ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì •ë³´ ë³µì›
      if (categoryData.customColor) {
        categoryColors[categoryData.name] = categoryData.customColor;
      }

      // ì´ë²¤íŠ¸ë“¤ ì¶”ê°€
      categoryData.events.forEach(function(eventData) {
        // ìŠ¤ì¼€ì¤„ë“¤ ì¶”ê°€
        eventData.schedules.forEach(function(scheduleData, scheduleIndex) {
          // ìŠ¤ì¼€ì¥´ ì»¬ëŸ¬ ì •ë³´ ë³µì›
          if (scheduleData.customColor) {
            scheduleColors[eventData.name + '_' + scheduleIndex] = scheduleData.customColor;
          }
        });
      });
    });
    
    importData.categories.forEach(function(categoryData, categoryIndex) {     
      
      // ì¹´í…Œê³ ë¦¬ ì¶”ê°€
      var newCategoryHtml = '<div class="category-header" data-category-index="' + categoryIndex + '">' +
        '<div class="category-left">' +
          '<button class="category-toggle-btn" type="button">â–¼</button>' +
          '<span class="category-title">' + categoryData.name + '</span>' +
        '</div>' +
        '<div class="category-actions">' +
          '<button class="category-btn add-event-btn" type="button" title="ì´ë²¤íŠ¸ ì¶”ê°€">+</button>' +
          '<button class="category-btn edit-category-btn" type="button" title="ì´ë¦„ ë³€ê²½">âœ</button>' +
          '<button class="category-btn color-category-btn" type="button" title="ìƒ‰ìƒ ë³€ê²½">ğŸ¨</button>' +
          '<button class="category-btn delete-category-btn" type="button" title="ì¹´í…Œê³ ë¦¬ ì‚­ì œ">Ã—</button>' +
        '</div>' +
      '</div>';
      
              $('.sidebar-content').append(newCategoryHtml);
        
        // íƒ€ì„ë¼ì¸ì— ì¹´í…Œê³ ë¦¬ í–‰ ì¶”ê°€ (ì¹´í…Œê³ ë¦¬ í–‰ì€ í´ë¦­ ë¶ˆê°€)
        var categoryCellsHtml = '';
        <% days.each do |day| %>
          categoryCellsHtml += '<div class="timeline-cell" style="width: <%= cell_width %>px;"></div>';
        <% end %>
        
        var categoryRowHtml = '<div class="timeline-row category-row" data-category-name="' + categoryData.name + '">' +
          '<div class="timeline-grid">' + categoryCellsHtml + '</div>' +
          '</div>';
        
        $('.timeline-body').append(categoryRowHtml);
        
        // ì´ë²¤íŠ¸ë“¤ ì¶”ê°€
        categoryData.events.forEach(function(eventData) {
          // ì‚¬ì´ë“œë°”ì— ì´ë²¤íŠ¸ ì¶”ê°€
          var eventHtml = '<div class="project-item" data-category-index="' + categoryIndex + '">' +
            '<div class="event-content">' +
              '<div class="project-name">' + eventData.name.replace(/\n/g, '<br>') + '</div>' +
              '<div class="project-info">' + eventData.schedules.length + 'ê°œ ìŠ¤ì¼€ì¤„</div>' +
            '</div>' +
            '<form class="event-edit-form">' +
              '<textarea class="event-edit-input">' + eventData.name + '</textarea>' +
            '</form>' +
            '<div class="event-actions">' +
              '<button class="event-btn edit-event-btn" title="í¸ì§‘">âœï¸</button>' +
              '<button class="event-btn delete-event-btn" title="ì‚­ì œ">ğŸ—‘ï¸</button>' +
            '</div>' +
            '<div class="event-edit-actions">' +
              '<button class="event-btn save-event-btn" title="ì €ì¥">âœ“</button>' +
              '<button class="event-btn cancel-event-btn" title="ì·¨ì†Œ">âœ•</button>' +
            '</div>' +
          '</div>';
          
          $('.sidebar-content').append(eventHtml);
        
          // íƒ€ì„ë¼ì¸ì— ì´ë²¤íŠ¸ í–‰ ì¶”ê°€ (ì´ë²¤íŠ¸ í–‰ì€ í´ë¦­ ê°€ëŠ¥)
          var eventCellsHtml = '';
          <% days.each_with_index do |day, index| %>
            eventCellsHtml += '<div class="timeline-cell schedule-add-target" style="width: <%= cell_width %>px;" data-date="<%= day[:date].strftime('%Y-%m-%d') %>"></div>';
          <% end %>
          
          var eventRowHtml = '<div class="timeline-row" data-event-name="' + eventData.name + '" data-category-name="' + categoryData.name + '">' +
            '<div class="timeline-grid">' + eventCellsHtml + '</div>' +
            '</div>';
        
        $('.timeline-body').append(eventRowHtml);
        
        var timelineRow = $('.timeline-row').last();
        
        // ìŠ¤ì¼€ì¤„ë“¤ ì¶”ê°€
        eventData.schedules.forEach(function(scheduleData, scheduleIndex) {
          if (scheduleData.startDate && scheduleData.endDate) {
            var startDate = new Date(<%= start_date.to_time.to_i * 1000 %>);
            var scheduleStartDate = parseLocalDate(scheduleData.startDate);
            var scheduleEndDate = parseLocalDate(scheduleData.endDate);
            
            var projectStartDays = Math.round((scheduleStartDate - startDate) / (1000 * 60 * 60 * 24));
            var projectDurationDays = Math.round((scheduleEndDate - scheduleStartDate) / (1000 * 60 * 60 * 24));
            var barLeft = projectStartDays * <%= cell_width %>;
            var barWidth = projectDurationDays * <%= cell_width %>;
            var totalWidth = <%= total_width %>;
            
            // í‘œì‹œ ë²”ìœ„ ë‚´ì— ìˆëŠ” ê²½ìš°ë§Œ ë°” ìƒì„±
            if (barLeft >= -barWidth && barLeft <= totalWidth) {
              // ìƒ‰ìƒ í™•ì¸ (ê°œë³„ ìƒ‰ìƒ > ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ)
              var scheduleKey = eventData.name + '_' + scheduleIndex;
              var scheduleColor = scheduleData.customColor || scheduleColors[scheduleKey];
              var categoryColor = getCategoryColor(categoryData.name);
              var appliedColor = scheduleColor || categoryColor;
              
              var barClass = appliedColor ? 'project-bar custom-color' : 'project-bar issue-' + scheduleData.issue;
              var barStyle = 'position: absolute; top: 2px; left: ' + Math.max(0, barLeft) + 'px; width: ' + Math.min(barWidth, totalWidth - Math.max(0, barLeft)) + 'px; z-index: ' + (101 + scheduleIndex) + ';';
              
              if (appliedColor) {
                barStyle += ' background-color: ' + appliedColor + ';';
              }
              
              // ì´ìŠˆ ë§í¬ ì•„ì´ì½˜ HTML (ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©)
              var issueLinkIcon = generateIssueLinkIcon(scheduleData.issue);
              
              var scheduleBarHtml = '<div class="' + barClass + '" ' +
                'style="' + barStyle + '" ' +
                'title="' + scheduleData.name + ' (' + scheduleData.startDate + ' ~ ' + scheduleData.endDate + ')" ' +
                'data-schedule-index="' + scheduleIndex + '" ' +
                'data-issue-number="' + scheduleData.issue + '" ' +
                'data-done-ratio="' + (scheduleData.doneRatio || '') + '">' +
                '<span class="project-bar-text">' + (scheduleData.name.length > 20 ? scheduleData.name.substring(0, 20) + '...' : scheduleData.name).replace(/\n/g, '<br>') + '</span>' +
                issueLinkIcon +
                '</div>';
              
              timelineRow.append(scheduleBarHtml);
              // ì›ë¬¸ ìŠ¤ì¼€ì¤„ëª…ì„ ë°ì´í„° ì†ì„±ìœ¼ë¡œ ë³´ì¡´
              timelineRow.find('.project-bar').last().attr('data-schedule-name', scheduleData.name);
            }
          }
        });
      });
    });
    
    // ì´ë²¤íŠ¸ ë° ì¹´í…Œê³ ë¦¬ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ë¨¼ì € ì´ˆê¸°í™” (ìµœì´ˆ ì ‘ì†ì‹œì™€ ë™ì¼í•œ ìˆœì„œ)
    initializeEventDragAndDrop();
    initializeCategoryDragAndDrop();
    
    // ë“œë˜ê·¸ ê¸°ëŠ¥ ì¬ì´ˆê¸°í™” (ë§ˆì§€ë§‰ì—)
    initializeProjectBarDraggable();
    
    // ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸ (ë”œë ˆì´ í›„ ì‹¤í–‰)
    setTimeout(function() {
      updateLineHeight();
    }, 100);
    
    console.log('ë¶ˆëŸ¬ì˜¨ ë°ì´í„° ì ìš© ì™„ë£Œ');
  }

  // ì´ìŠˆ ë§í¬ ì•„ì´ì½˜ HTML ìƒì„± í•¨ìˆ˜ (ê³µí†µ)
  function generateIssueLinkIcon(issueNumber) {
    if (!issueNumber || issueNumber.trim() === '') {
      return '';
    }
    
    return '<a href="/issues/' + issueNumber + '" class="issue-link-icon" target="_blank" title="" data-issue-tooltip="' + issueNumber + '">' +
      '<span class="issue-link-symbol">ğŸ”—</span>' +
      '</a>';
  }

  // ê¸°ì¡´ ìŠ¤ì¼€ì¥´ë°”ë“¤ì— ì´ìŠˆ ë§í¬ ì•„ì´ì½˜ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
  function addIssueLinkIconsToExistingBars() {
    $('.project-bar').each(function() {
      var $bar = $(this);
      var issueNumber = $bar.attr('data-issue-number');
      
      // ì´ë¯¸ ì´ìŠˆ ë§í¬ ì•„ì´ì½˜ì´ ìˆê±°ë‚˜ ì´ìŠˆ ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
      if ($bar.find('.issue-link-icon').length > 0 || !issueNumber || issueNumber.trim() === '') {
        return;
      }
      
      // ê³µí†µ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ìŠˆ ë§í¬ ì•„ì´ì½˜ ì¶”ê°€
      var issueLinkIcon = generateIssueLinkIcon(issueNumber);
      $bar.append(issueLinkIcon);
    });
  }

  // ê¸°ì¡´ ìŠ¤ì¼€ì¤„ ë°”ë“¤ì— ì›ë¬¸ ìŠ¤ì¼€ì¤„ëª… ì†ì„± ë³´ì • í•¨ìˆ˜
  function initializeScheduleNameAttributes() {
    $('.project-bar').each(function() {
      var $bar = $(this);
      // ì´ë¯¸ ì›ë¬¸ ì†ì„±ì´ ìˆìœ¼ë©´ ìœ ì§€
      var originalName = $bar.attr('data-schedule-name');
      if (originalName && originalName.trim() !== '') {
        return;
      }
      // titleì—ì„œ ì´ë¦„ ë¶€ë¶„ë§Œ ì¶”ì¶œ ì‹œë„: "ì´ë¦„ (YYYY-MM-DD ~ YYYY-MM-DD)"
      var title = $bar.attr('title') || '';
      var match = title.match(/^(.*) \(\d{4}-\d{2}-\d{2} ~ \d{4}-\d{2}-\d{2}\)$/);
      if (match && match[1]) {
        $bar.attr('data-schedule-name', match[1]);
        return;
      }
      // fallback: í‘œì‹œ í…ìŠ¤íŠ¸ ì‚¬ìš© (â€¦ì¼ ìˆ˜ ìˆìŒ)
      var displayText = $bar.find('.project-bar-text').text().trim();
      if (displayText) {
        $bar.attr('data-schedule-name', displayText);
      }
    });
  }


// íŠ¹ì • í–‰ì˜ í”„ë¡œì íŠ¸ ë°” ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì´ˆê¸°í™”
  function initializeProjectBarDraggableForRow($row) {
    if (!$row || $row.length === 0) return;
    
    var $projectBars = $row.find('.project-bar');
    console.log('ìƒˆ í–‰ì˜ í”„ë¡œì íŠ¸ ë°” ê°œìˆ˜:', $projectBars.length);
    
    // ê° í”„ë¡œì íŠ¸ ë°”ì— z-index ì¬ì„¤ì • (í˜¹ì‹œ ëˆ„ë½ëœ ê²½ìš°)
    $projectBars.each(function(index) {
      var $bar = $(this);
      if (!$bar.data('schedule-index')) {
        $bar.attr('data-schedule-index', index);
      }
      
      // z-indexê°€ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì— ì—†ìœ¼ë©´ ì¶”ê°€
      var currentStyle = $bar.attr('style') || '';
      if (currentStyle.indexOf('z-index') === -1) {
        var zIndex = 101 + index;
        $bar.attr('style', currentStyle + '; z-index: ' + zIndex + ';');
      }
    });
    
    applyDraggableToElements($projectBars);
  }

  // í”„ë¡œì íŠ¸ ë°” ë“œë˜ê·¸ ë° ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì´ˆê¸°í™”
  function initializeProjectBarDraggable() {
    // ê¸°ì¡´ ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì œê±° (ì´ë¯¸ ì´ˆê¸°í™”ëœ ê²ƒë“¤ë§Œ)
    $('.project-bar').each(function() {
      if ($(this).hasClass('ui-draggable')) {
        $(this).draggable('destroy');
      }
      if ($(this).hasClass('ui-resizable')) {
        $(this).resizable('destroy');
      }
    });
    
    // ëª¨ë“  í”„ë¡œì íŠ¸ ë°”ì— ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì ìš©
    applyDraggableToElements($('.project-bar'));
  }

  // í”„ë¡œì íŠ¸ ë°” ìš”ì†Œë“¤ì— ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì ìš©
  function applyDraggableToElements($elements) {
    if (!$elements || $elements.length === 0) return;
    
    console.log('ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì ìš© ëŒ€ìƒ:', $elements.length, 'ê°œ ìš”ì†Œ');
    
    // ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì¶”ê°€ (ì–‘ìª½ ë ë“œë˜ê·¸ë¡œ í¬ê¸° ì¡°ì •)
    $elements.resizable({
      handles: 'e, w', // ë™ìª½(ìš°ì¸¡), ì„œìª½(ì¢Œì¸¡) í•¸ë“¤ë§Œ í™œì„±í™”
      grid: [<%= cell_width %>, 0], // ì¼ ë‹¨ìœ„ë¡œ ìŠ¤ëƒ…
      minWidth: <%= cell_width %>, // ìµœì†Œ 1ì¼ í¬ê¸°
      containment: '.timeline-body',
      start: function(event, ui) {
        $(this).addClass('ui-resizable-resizing');
        // ë¦¬ì‚¬ì´ì¦ˆ ì‹œì‘ ìœ„ì¹˜ì™€ í¬ê¸° ì €ì¥
        $(this).data('startLeft', ui.position.left);
        $(this).data('startWidth', ui.size.width);
      },
      resize: function(event, ui) {
        // ë¦¬ì‚¬ì´ì¦ˆ ì¤‘ ë‚ ì§œ ì—…ë°ì´íŠ¸
        updateProjectDatesFromResize($(this), ui.position.left, ui.size.width);
      },
      stop: function(event, ui) {
        $(this).removeClass('ui-resizable-resizing');
        
        // ìµœì¢… í¬ê¸°ì™€ ìœ„ì¹˜ì—ì„œì˜ ë‚ ì§œ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
        var finalDates = calculateProjectDatesFromResize($(this), ui.position.left, ui.size.width);
        var projectId = $(this).data('project-id');
        
        console.log('í”„ë¡œì íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ ì™„ë£Œ:', {
          id: projectId,
          startDate: finalDates.startDate,
          endDate: finalDates.endDate
        });
        
        // ì‚¬ì´ë“œë°”ì˜ í”„ë¡œì íŠ¸ ì •ë³´ë„ ì—…ë°ì´íŠ¸
        updateSidebarProjectInfo($(this), finalDates);
      }
    });
    
    // ë“œë˜ê·¸ ê¸°ëŠ¥ ì¶”ê°€ (ì¤‘ì•™ ë¶€ë¶„ ë“œë˜ê·¸ë¡œ ì´ë™)
    $elements.draggable({
      axis: 'x', // xì¶•ìœ¼ë¡œë§Œ ë“œë˜ê·¸ ê°€ëŠ¥
      grid: [<%= cell_width %>, 0], // ì¼ ë‹¨ìœ„ë¡œ ìŠ¤ëƒ…
      containment: '.timeline-body', // íƒ€ì„ë¼ì¸ ì˜ì—­ ë‚´ì—ì„œë§Œ ë“œë˜ê·¸ ê°€ëŠ¥
      cancel: '.ui-resizable-handle', // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ì—ì„œëŠ” ë“œë˜ê·¸ ë¹„í™œì„±í™”
      start: function(event, ui) {
        $(this).addClass('ui-draggable-dragging');
        // ì‹œì‘ ìœ„ì¹˜ ì €ì¥
        $(this).data('startLeft', ui.position.left);
      },
      drag: function(event, ui) {
        // ë“œë˜ê·¸ ì¤‘ ìœ„ì¹˜ì— ë”°ë¥¸ ë‚ ì§œ ì—…ë°ì´íŠ¸
        updateProjectDates($(this), ui.position.left);
      },
      stop: function(event, ui) {
        $(this).removeClass('ui-draggable-dragging');
        
        // ìµœì¢… ìœ„ì¹˜ì—ì„œì˜ ë‚ ì§œ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
        var finalDates = calculateProjectDates($(this), ui.position.left);
        var projectId = $(this).data('project-id');
        
        console.log('í”„ë¡œì íŠ¸ ì´ë™ ì™„ë£Œ:', {
          id: projectId,
          startDate: finalDates.startDate,
          endDate: finalDates.endDate
        });
        
        // ì‚¬ì´ë“œë°”ì˜ í”„ë¡œì íŠ¸ ì •ë³´ë„ ì—…ë°ì´íŠ¸
        updateSidebarProjectInfo($(this), finalDates);
      }
    });
  }

  // ì´ë²¤íŠ¸ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì´ˆê¸°í™”
  function initializeEventDragAndDrop() {
    console.log('ì´ë²¤íŠ¸ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì´ˆê¸°í™”');
    
    var dragStartData = null;
    var dragHelper = null;
    
    // ì´ë²¤íŠ¸ ì•„ì´í…œì— ë“œë˜ê·¸ ê¸°ëŠ¥ ì¶”ê°€
    $(document).on('mousedown', '.project-item .event-content', function(e) {
      // í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ë“œë˜ê·¸ ë¹„í™œì„±í™”
      if ($(this).closest('.project-item').hasClass('editing')) {
        return;
      }
      
      // ì˜¤ë¥¸ìª½ í´ë¦­ ë¬´ì‹œ
      if (e.which !== 1) {
        return;
      }
      
      var eventItem = $(this).closest('.project-item');
      var eventName = eventItem.find('.project-name').text().trim();
      var sourceCategoryIndex = eventItem.data('category-index');
      
      dragStartData = {
        eventItem: eventItem,
        eventName: eventName,
        sourceCategoryIndex: sourceCategoryIndex,
        startX: e.pageX,
        startY: e.pageY,
        isDragging: false
      };
      
      console.log('ë“œë˜ê·¸ ì‹œì‘ ì¤€ë¹„:', dragStartData);
      
      // ì „ì—­ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì¶”ê°€
      $(document).on('mousemove.eventDrag', handleMouseMove);
      $(document).on('mouseup.eventDrag', handleMouseUp);
      
      e.preventDefault();
    });
    
    function handleMouseMove(e) {
      if (!dragStartData) return;
      
      var deltaX = Math.abs(e.pageX - dragStartData.startX);
      var deltaY = Math.abs(e.pageY - dragStartData.startY);
      
      // ë“œë˜ê·¸ ì‹œì‘ ì„ê³„ê°’ í™•ì¸
      if (!dragStartData.isDragging && (deltaX > 5 || deltaY > 5)) {
        startDrag(e);
      }
      
      if (dragStartData.isDragging) {
        updateDragPosition(e);
        updateDropZones(e);
      }
    }
    
    function handleMouseUp(e) {
      if (dragStartData && dragStartData.isDragging) {
        finishDrag(e);
      }
      
      // ì „ì—­ ì´ë²¤íŠ¸ ì œê±°
      $(document).off('mousemove.eventDrag');
      $(document).off('mouseup.eventDrag');
      
      dragStartData = null;
    }
    
    function startDrag(e) {
      console.log('ë“œë˜ê·¸ ì‹œì‘:', dragStartData.eventName);
      
      dragStartData.isDragging = true;
      dragStartData.eventItem.addClass('dragging');
      
      // ë“œë˜ê·¸ í—¬í¼ ìƒì„±
      dragHelper = $('<div class="project-item drag-helper">' + 
                     '<div class="event-content">' +
                     '<div class="project-name">' + dragStartData.eventName + '</div>' +
                     '</div>' +
                     '</div>');
      
      $('body').append(dragHelper);
      updateDragPosition(e);
      
      // ë“œë¡­ ì¡´ í™œì„±í™”
      // 1. ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ í—¤ë”ë“¤ì„ ë“œë¡­ ì¡´ìœ¼ë¡œ ì„¤ì •
      $('.category-header').not('[data-category-index="' + dragStartData.sourceCategoryIndex + '"]')
                          .addClass('drop-zone');
      
      // 2. ê°™ì€ ì¹´í…Œê³ ë¦¬ ë‚´ì˜ ë‹¤ë¥¸ ì´ë²¤íŠ¸ë“¤ì„ ë“œë¡­ ì¡´ìœ¼ë¡œ ì„¤ì •
      $('.project-item[data-category-index="' + dragStartData.sourceCategoryIndex + '"]')
                          .not(dragStartData.eventItem)
                          .addClass('drop-zone');
    }
    
    function updateDragPosition(e) {
      if (dragHelper) {
        dragHelper.css({
          left: e.pageX + 10,
          top: e.pageY - 10
        });
      }
    }
    
    function updateDropZones(e) {
      // í˜„ì¬ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì˜ ë“œë¡­ ì¡´ ì°¾ê¸°
      var categoryDropTarget = $(e.target).closest('.category-header.drop-zone');
      var eventDropTarget = $(e.target).closest('.project-item.drop-zone');
      
      // ëª¨ë“  ë“œë¡­ ì¡´ì—ì„œ hover íš¨ê³¼ ì œê±°
      $('.category-header.drop-zone').removeClass('drop-zone-hover');
      $('.project-item.drop-zone').removeClass('drop-zone-hover');
      
      // í˜„ì¬ ìœ„ì¹˜ì˜ ë“œë¡­ ì¡´ì— hover íš¨ê³¼ ì¶”ê°€ ë° í—¬í¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      if (categoryDropTarget.length > 0) {
        categoryDropTarget.addClass('drop-zone-hover');
        updateDragHelperText('ì¹´í…Œê³ ë¦¬ ì´ë™');
      } else if (eventDropTarget.length > 0) {
        eventDropTarget.addClass('drop-zone-hover');
        updateDragHelperText('ìˆœì„œ ë³€ê²½');
      } else {
        updateDragHelperText('ì´ë™');
      }
    }
    
    function updateDragHelperText(action) {
      if (dragHelper) {
        var helperText = dragHelper.find('.drag-helper-action');
        if (helperText.length === 0) {
          dragHelper.append('<div class="drag-helper-action" style="font-size: 10px; color: #666; margin-top: 2px;"></div>');
          helperText = dragHelper.find('.drag-helper-action');
        }
        helperText.text(action);
      }
    }
    
    function finishDrag(e) {
      console.log('ë“œë˜ê·¸ ì™„ë£Œ');
      
      // ë“œë¡­ íƒ€ê²Ÿ ì°¾ê¸°
      var categoryDropTarget = $(e.target).closest('.category-header.drop-zone');
      var eventDropTarget = $(e.target).closest('.project-item.drop-zone');
      
      if (categoryDropTarget.length > 0) {
        // ì¹´í…Œê³ ë¦¬ í—¤ë”ì— ë“œë¡­ - ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™
        var targetCategoryIndex = categoryDropTarget.data('category-index');
        
        if (targetCategoryIndex != dragStartData.sourceCategoryIndex) {
          try {
            moveEventToCategory(dragStartData.eventItem, dragStartData.sourceCategoryIndex, targetCategoryIndex);
          } catch (error) {
            console.error('ì´ë²¤íŠ¸ ì´ë™ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            alert('ì´ë²¤íŠ¸ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
          }
        } else {
          console.log('ê°™ì€ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™ ì‹œë„ - ë¬´ì‹œ');
        }
      } else if (eventDropTarget.length > 0) {
        // ì´ë²¤íŠ¸ ì•„ì´í…œì— ë“œë¡­ - ê°™ì€ ì¹´í…Œê³ ë¦¬ ë‚´ ìˆœì„œ ë³€ê²½
        var targetEventCategoryIndex = eventDropTarget.data('category-index');
        
        if (targetEventCategoryIndex == dragStartData.sourceCategoryIndex) {
          try {
            reorderEventInCategory(dragStartData.eventItem, eventDropTarget);
          } catch (error) {
            console.error('ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            alert('ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
          }
        } else {
          console.log('ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ì˜ ì´ë²¤íŠ¸ì— ë“œë¡­ - ë¬´ì‹œ');
        }
      }
      
      // ì •ë¦¬
      cleanup();
    }
    
    function cleanup() {
      if (dragHelper) {
        dragHelper.remove();
        dragHelper = null;
      }
      
      $('.project-item').removeClass('dragging');
      $('.category-header').removeClass('drop-zone drop-zone-hover');
      $('.project-item').removeClass('drop-zone drop-zone-hover');
    }
    
    function moveEventToCategory(eventItem, sourceCategoryIndex, targetCategoryIndex) {
      console.log('ì´ë²¤íŠ¸ ì¹´í…Œê³ ë¦¬ ì´ë™:', sourceCategoryIndex, '->', targetCategoryIndex);
      
      var eventName = eventItem.find('.project-name').text().trim();
      var targetCategoryHeader = $('.category-header[data-category-index="' + targetCategoryIndex + '"]');
      var sourceCategoryHeader = $('.category-header[data-category-index="' + sourceCategoryIndex + '"]');
      
      if (targetCategoryHeader.length === 0) {
        console.error('íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      // ì›ë³¸ ì¹´í…Œê³ ë¦¬ì™€ íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
      var sourceCategoryName = sourceCategoryHeader.find('.category-title').text().trim();
      var targetCategoryName = targetCategoryHeader.find('.category-title').text().trim();
      
      console.log('ì¹´í…Œê³ ë¦¬ ì´ë¦„:', sourceCategoryName, '->', targetCategoryName);
      
      // 1. ì‚¬ì´ë“œë°”ì—ì„œ ì´ë²¤íŠ¸ ì•„ì´í…œ ì´ë™
      var newEventItem = eventItem.clone();
      newEventItem.attr('data-category-index', targetCategoryIndex);
      
      // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ì˜ ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ ë‹¤ìŒì— ì‚½ì…
      var targetCategoryEvents = $('.project-item[data-category-index="' + targetCategoryIndex + '"]');
      if (targetCategoryEvents.length > 0) {
        targetCategoryEvents.last().after(newEventItem);
      } else {
        targetCategoryHeader.after(newEventItem);
      }
      
      // 2. íƒ€ì„ë¼ì¸ì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ëª¨ë“  í–‰ ì°¾ê¸°
      var originalTimelineRows = $('.timeline-row[data-category-name="' + sourceCategoryName + '"][data-event-name="' + eventName + '"]');
      console.log('ì´ë™í•  íƒ€ì„ë¼ì¸ í–‰ ê°œìˆ˜:', originalTimelineRows.length);
      
      // 3. íƒ€ì„ë¼ì¸ í–‰ë“¤ì„ ìƒˆë¡œìš´ ìœ„ì¹˜ë¡œ ì´ë™
      if (originalTimelineRows.length > 0) {
        // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ì—ì„œ ì´ë²¤íŠ¸ ì‚½ì… ìœ„ì¹˜ ì°¾ê¸°
        var insertPosition = findTimelineInsertPosition(targetCategoryIndex, eventName);
        
        // ê° í–‰ì„ ìƒˆë¡œìš´ ìœ„ì¹˜ë¡œ ì´ë™í•˜ê³  ë°ì´í„° ì†ì„± ì—…ë°ì´íŠ¸
        originalTimelineRows.each(function() {
          var $row = $(this);
          $row.attr('data-category-name', targetCategoryName);
          
          // í–‰ì„ ìƒˆë¡œìš´ ìœ„ì¹˜ë¡œ ì´ë™
          if (insertPosition && insertPosition.length > 0) {
            $row.detach().insertAfter(insertPosition);
            insertPosition = $row; // ë‹¤ìŒ í–‰ì€ í˜„ì¬ í–‰ ë‹¤ìŒì— ì‚½ì…
          } else {
            // ì‚½ì… ìœ„ì¹˜ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° íƒ€ì„ë¼ì¸ ëì— ì¶”ê°€
            $row.detach().appendTo('.timeline-body');
          }
        });
      }
      
      // 4. ì›ë³¸ ì´ë²¤íŠ¸ ì•„ì´í…œ ì œê±°
      eventItem.remove();
      
      // 5. í”„ë¡œì íŠ¸ ë°” ë“œë˜ê·¸ ê¸°ëŠ¥ ì¬ì´ˆê¸°í™”
      initializeProjectBarDraggable();
      
      // 6. ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸
      updateLineHeight();
      
      console.log('ì´ë²¤íŠ¸ ì´ë™ ì™„ë£Œ:', eventName);
    }
    
    // ê°™ì€ ì¹´í…Œê³ ë¦¬ ë‚´ì—ì„œ ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½
    function reorderEventInCategory(sourceEventItem, targetEventItem) {
      console.log('ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ ì‹œì‘');
      
      var sourceEventName = sourceEventItem.find('.project-name').text().trim();
      var targetEventName = targetEventItem.find('.project-name').text().trim();
      var categoryIndex = sourceEventItem.data('category-index');
      var categoryName = $('.category-header[data-category-index="' + categoryIndex + '"]')
                         .find('.category-title').text().trim();
      
      console.log('ìˆœì„œ ë³€ê²½:', sourceEventName, '->', targetEventName, '(ì¹´í…Œê³ ë¦¬:', categoryName + ')');
      
      // 1. ì‚¬ì´ë“œë°”ì—ì„œ ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½
      var sourceIndex = sourceEventItem.index();
      var targetIndex = targetEventItem.index();
      
      console.log('ì‚¬ì´ë“œë°” ì¸ë±ìŠ¤:', sourceIndex, '->', targetIndex);
      
      if (sourceIndex < targetIndex) {
        // ì•„ë˜ìª½ìœ¼ë¡œ ì´ë™ - íƒ€ê²Ÿ ìš”ì†Œ ë‹¤ìŒì— ì‚½ì…
        sourceEventItem.detach().insertAfter(targetEventItem);
      } else {
        // ìœ„ìª½ìœ¼ë¡œ ì´ë™ - íƒ€ê²Ÿ ìš”ì†Œ ì´ì „ì— ì‚½ì…
        sourceEventItem.detach().insertBefore(targetEventItem);
      }
      
      // 2. íƒ€ì„ë¼ì¸ì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ëª¨ë“  í–‰ ì°¾ê¸°
      var sourceTimelineRows = $('.timeline-row[data-category-name="' + categoryName + '"][data-event-name="' + sourceEventName + '"]');
      var targetTimelineRows = $('.timeline-row[data-category-name="' + categoryName + '"][data-event-name="' + targetEventName + '"]');
      
      console.log('íƒ€ì„ë¼ì¸ í–‰ ê°œìˆ˜ - ì†ŒìŠ¤:', sourceTimelineRows.length, 'íƒ€ê²Ÿ:', targetTimelineRows.length);
      
      // 3. íƒ€ì„ë¼ì¸ì—ì„œ ì´ë²¤íŠ¸ í–‰ ìˆœì„œ ë³€ê²½
      if (sourceTimelineRows.length > 0 && targetTimelineRows.length > 0) {
        var targetLastRow = targetTimelineRows.last();
        var targetFirstRow = targetTimelineRows.first();
        
        if (sourceIndex < targetIndex) {
          // ì•„ë˜ìª½ìœ¼ë¡œ ì´ë™ - íƒ€ê²Ÿ ì´ë²¤íŠ¸ì˜ ë§ˆì§€ë§‰ í–‰ ë‹¤ìŒì— ì‚½ì…
          sourceTimelineRows.each(function() {
            $(this).detach().insertAfter(targetLastRow);
            targetLastRow = $(this); // ë‹¤ìŒ í–‰ì€ í˜„ì¬ í–‰ ë‹¤ìŒì— ì‚½ì…
          });
        } else {
          // ìœ„ìª½ìœ¼ë¡œ ì´ë™ - íƒ€ê²Ÿ ì´ë²¤íŠ¸ì˜ ì²« ë²ˆì§¸ í–‰ ì´ì „ì— ì‚½ì…
          sourceTimelineRows.get().reverse().forEach(function(row) {
            $(row).detach().insertBefore(targetFirstRow);
          });
        }
      }
      
      // 4. ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸
      updateLineHeight();
      
      console.log('ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ ì™„ë£Œ:', sourceEventName);
    }
    
    // íƒ€ì„ë¼ì¸ì—ì„œ ìƒˆ ì´ë²¤íŠ¸ í–‰ì˜ ì‚½ì… ìœ„ì¹˜ë¥¼ ì°¾ëŠ” í•¨ìˆ˜
    function findTimelineInsertPosition(categoryIndex, eventName) {
      var categoryName = $('.category-header[data-category-index="' + categoryIndex + '"]')
                         .find('.category-title').text().trim();
      
      console.log('íƒ€ì„ë¼ì¸ ì‚½ì… ìœ„ì¹˜ ì°¾ê¸°:', categoryName, eventName);
      
      // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ê¸°ì¡´ íƒ€ì„ë¼ì¸ í–‰ë“¤ ì°¾ê¸°
      var categoryTimelineRows = $('.timeline-row[data-category-name="' + categoryName + '"]');
      console.log('ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ íƒ€ì„ë¼ì¸ í–‰ ê°œìˆ˜:', categoryTimelineRows.length);
      
      if (categoryTimelineRows.length > 0) {
        return categoryTimelineRows.last();
      }
      
      // ì¹´í…Œê³ ë¦¬ í–‰ì´ ì—†ëŠ” ê²½ìš°, ì‚¬ì´ë“œë°” ìˆœì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‚½ì… ìœ„ì¹˜ ì°¾ê¸°
      var allTimelineRows = $('.timeline-row');
      var sidebarElements = $('.timeline-sidebar').children().not('.sidebar-header');
      
      // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ì˜ ì‚¬ì´ë“œë°” ìœ„ì¹˜ ì°¾ê¸°
      var targetCategoryPosition = -1;
      sidebarElements.each(function(index) {
        if ($(this).hasClass('category-header') && 
            $(this).data('category-index') == categoryIndex) {
          targetCategoryPosition = index;
          return false; // break
        }
      });
      
      console.log('íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ ìœ„ì¹˜:', targetCategoryPosition);
      
      if (targetCategoryPosition >= 0) {
        // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ ì´ì „ ìš”ì†Œë“¤ ì¤‘ì—ì„œ ë§ˆì§€ë§‰ íƒ€ì„ë¼ì¸ í–‰ ì°¾ê¸°
        var insertAfterRow = null;
        var timelineIndex = 0;
        
        for (var i = 0; i < targetCategoryPosition; i++) {
          var sidebarElement = sidebarElements.eq(i);
          if (sidebarElement.hasClass('category-header') || sidebarElement.hasClass('project-item')) {
            if (timelineIndex < allTimelineRows.length) {
              insertAfterRow = allTimelineRows.eq(timelineIndex);
              timelineIndex++;
            }
          }
        }
        
        console.log('ì‚½ì… ìœ„ì¹˜ (ì´ì „ í–‰):', insertAfterRow ? insertAfterRow.index() : 'none');
        return insertAfterRow;
      }
      
      // ë§ˆì§€ë§‰ ìˆ˜ë‹¨ìœ¼ë¡œ íƒ€ì„ë¼ì¸ ëì— ì‚½ì…
      console.log('ë§ˆì§€ë§‰ ìˆ˜ë‹¨: íƒ€ì„ë¼ì¸ ëì— ì‚½ì…');
      return allTimelineRows.last();
    }
  }

  // ì¹´í…Œê³ ë¦¬ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì´ˆê¸°í™”
  function initializeCategoryDragAndDrop() {
    console.log('ì¹´í…Œê³ ë¦¬ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì´ˆê¸°í™”');
    
    var categoryDragData = null;
    var categoryDragHelper = null;
    
    // ì¹´í…Œê³ ë¦¬ í—¤ë”ì— ë“œë˜ê·¸ ê¸°ëŠ¥ ì¶”ê°€
    $(document).on('mousedown', '.category-header .category-title', function(e) {
      // í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ë“œë˜ê·¸ ë¹„í™œì„±í™”
      if ($(this).closest('.category-header').hasClass('editing')) {
        return;
      }
      
      // ì˜¤ë¥¸ìª½ í´ë¦­ ë¬´ì‹œ
      if (e.which !== 1) {
        return;
      }
      
      var categoryHeader = $(this).closest('.category-header');
      var categoryName = $(this).text().trim();
      var categoryIndex = categoryHeader.data('category-index');
      
      categoryDragData = {
        categoryHeader: categoryHeader,
        categoryName: categoryName,
        categoryIndex: categoryIndex,
        startX: e.pageX,
        startY: e.pageY,
        isDragging: false
      };
      
      console.log('ì¹´í…Œê³ ë¦¬ ë“œë˜ê·¸ ì‹œì‘ ì¤€ë¹„:', categoryDragData);
      
      // ì „ì—­ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì¶”ê°€
      $(document).on('mousemove.categoryDrag', handleCategoryMouseMove);
      $(document).on('mouseup.categoryDrag', handleCategoryMouseUp);
      
      e.preventDefault();
    });
    
    function handleCategoryMouseMove(e) {
      if (!categoryDragData) return;
      
      var deltaX = Math.abs(e.pageX - categoryDragData.startX);
      var deltaY = Math.abs(e.pageY - categoryDragData.startY);
      
      // ë“œë˜ê·¸ ì‹œì‘ ì„ê³„ê°’ í™•ì¸
      if (!categoryDragData.isDragging && (deltaX > 5 || deltaY > 5)) {
        startCategoryDrag(e);
      }
      
      if (categoryDragData.isDragging) {
        updateCategoryDragPosition(e);
        updateCategoryDropZones(e);
      }
    }
    
    function handleCategoryMouseUp(e) {
      if (categoryDragData && categoryDragData.isDragging) {
        finishCategoryDrag(e);
      }
      
      // ì „ì—­ ì´ë²¤íŠ¸ ì œê±°
      $(document).off('mousemove.categoryDrag');
      $(document).off('mouseup.categoryDrag');
      
      categoryDragData = null;
    }
    
    function startCategoryDrag(e) {
      console.log('ì¹´í…Œê³ ë¦¬ ë“œë˜ê·¸ ì‹œì‘:', categoryDragData.categoryName);
      
      categoryDragData.isDragging = true;
      categoryDragData.categoryHeader.addClass('dragging');
      
      // ë“œë˜ê·¸ í—¬í¼ ìƒì„±
      categoryDragHelper = $('<div class="category-header drag-helper">' + 
                            '<div class="category-left">' +
                            '<span class="category-title">' + categoryDragData.categoryName + '</span>' +
                            '</div>' +
                            '</div>');
      
      $('body').append(categoryDragHelper);
      updateCategoryDragPosition(e);
      
      // ë“œë¡­ ì¡´ í™œì„±í™” - ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ë“¤ì„ ë“œë¡­ ì¡´ìœ¼ë¡œ ì„¤ì •
      $('.category-header').not(categoryDragData.categoryHeader).addClass('category-drop-zone');
    }
    
    function updateCategoryDragPosition(e) {
      if (categoryDragHelper) {
        categoryDragHelper.css({
          left: e.pageX + 10,
          top: e.pageY - 10
        });
      }
    }
    
    function updateCategoryDropZones(e) {
      // í˜„ì¬ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì˜ ë“œë¡­ ì¡´ ì°¾ê¸°
      var dropTarget = $(e.target).closest('.category-header.category-drop-zone');
      
      // ëª¨ë“  ë“œë¡­ ì¡´ì—ì„œ hover íš¨ê³¼ ì œê±°
      $('.category-header.category-drop-zone').removeClass('category-drop-zone-hover');
      
      // í˜„ì¬ ìœ„ì¹˜ì˜ ë“œë¡­ ì¡´ì— hover íš¨ê³¼ ì¶”ê°€
      if (dropTarget.length > 0) {
        dropTarget.addClass('category-drop-zone-hover');
        
        // ë“œë¡­ ìœ„ì¹˜ í‘œì‹œ (ìœ„/ì•„ë˜)
        var dropY = e.pageY - dropTarget.offset().top;
        var dropHeight = dropTarget.outerHeight();
        
        if (dropY < dropHeight / 2) {
          dropTarget.removeClass('drop-after').addClass('drop-before');
        } else {
          dropTarget.removeClass('drop-before').addClass('drop-after');
        }
      }
    }
    
    function finishCategoryDrag(e) {
      console.log('ì¹´í…Œê³ ë¦¬ ë“œë˜ê·¸ ì™„ë£Œ');
      
      // ë“œë¡­ íƒ€ê²Ÿ ì°¾ê¸°
      var dropTarget = $(e.target).closest('.category-header.category-drop-zone');
      
      if (dropTarget.length > 0) {
        var targetIndex = dropTarget.data('category-index');
        
        // ë“œë¡­ ìœ„ì¹˜ í™•ì¸ (ìœ„/ì•„ë˜)
        var dropY = e.pageY - dropTarget.offset().top;
        var dropHeight = dropTarget.outerHeight();
        var insertBefore = dropY < dropHeight / 2;
        
        try {
          reorderCategory(categoryDragData.categoryHeader, dropTarget, insertBefore);
        } catch (error) {
          console.error('ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
          alert('ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        }
      }
      
      // ì •ë¦¬
      cleanupCategoryDrag();
    }
    
    function cleanupCategoryDrag() {
      if (categoryDragHelper) {
        categoryDragHelper.remove();
        categoryDragHelper = null;
      }
      
      $('.category-header').removeClass('dragging category-drop-zone category-drop-zone-hover drop-before drop-after');
    }
    
    // ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ í•¨ìˆ˜
    function reorderCategory(sourceCategory, targetCategory, insertBefore) {
      console.log('ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ ì‹œì‘');
      
      var sourceName = sourceCategory.find('.category-title').text().trim();
      var targetName = targetCategory.find('.category-title').text().trim();
      var sourceIndex = sourceCategory.data('category-index');
      var targetIndex = targetCategory.data('category-index');
      
      console.log('ìˆœì„œ ë³€ê²½:', sourceName, 'â†’', targetName, '(ì‚½ì… ìœ„ì¹˜:', insertBefore ? 'ìœ„' : 'ì•„ë˜', ')');
      
      // 1. ì‚¬ì´ë“œë°”ì—ì„œ ì¹´í…Œê³ ë¦¬ì™€ í•´ë‹¹ ì´ë²¤íŠ¸ë“¤ ì´ë™
      var sourceEvents = $('.project-item[data-category-index="' + sourceIndex + '"]');
      console.log('ì´ë™í•  ì´ë²¤íŠ¸ ìˆ˜:', sourceEvents.length);
      
      // ì¹´í…Œê³ ë¦¬ì™€ ì´ë²¤íŠ¸ë“¤ì„ í•œ ë²ˆì— ì´ë™
      var elementsToMove = sourceCategory.add(sourceEvents);
      
      if (insertBefore) {
        elementsToMove.detach().insertBefore(targetCategory);
      } else {
        // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ì˜ ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ ì°¾ê¸°
        var targetEvents = $('.project-item[data-category-index="' + targetIndex + '"]');
        if (targetEvents.length > 0) {
          elementsToMove.detach().insertAfter(targetEvents.last());
        } else {
          elementsToMove.detach().insertAfter(targetCategory);
        }
      }
      
      // 2. íƒ€ì„ë¼ì¸ì—ì„œ ì¹´í…Œê³ ë¦¬ í–‰ê³¼ ì´ë²¤íŠ¸ í–‰ë“¤ ì´ë™
      reorderTimelineForCategory(sourceName, targetName, insertBefore);
      
      // 3. ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸
      setTimeout(function() {
        updateLineHeight();
      }, 50);
      
      console.log('ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ ì™„ë£Œ');
    }
    
    // íƒ€ì„ë¼ì¸ì—ì„œ ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½
    function reorderTimelineForCategory(sourceCategoryName, targetCategoryName, insertBefore) {
      console.log('íƒ€ì„ë¼ì¸ ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½:', sourceCategoryName, 'â†’', targetCategoryName);
      
      // 1ë‹¨ê³„: íƒ€ì„ë¼ì¸ì—ì„œ ì¹´í…Œê³ ë¦¬ ì´ë¦„ìœ¼ë¡œ ì¹´í…Œê³ ë¦¬ í–‰ê³¼ ì´ë²¤íŠ¸ í–‰ë“¤ ì°¾ê¸°
      var sourceCategoryRow = $('.timeline-row.category-row[data-category-name="' + sourceCategoryName + '"]');
      var targetCategoryRow = $('.timeline-row.category-row[data-category-name="' + targetCategoryName + '"]');
      var sourceEventRows = $('.timeline-row[data-category-name="' + sourceCategoryName + '"]').not('.category-row');
      var targetEventRows = $('.timeline-row[data-category-name="' + targetCategoryName + '"]').not('.category-row');
      
      console.log('ì†ŒìŠ¤ ì¹´í…Œê³ ë¦¬ í–‰:', sourceCategoryRow.length);
      console.log('ì†ŒìŠ¤ ì´ë²¤íŠ¸ í–‰ ìˆ˜:', sourceEventRows.length);
      console.log('íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ í–‰:', targetCategoryRow.length);
      console.log('íƒ€ê²Ÿ ì´ë²¤íŠ¸ í–‰ ìˆ˜:', targetEventRows.length);
      
      if (sourceCategoryRow.length === 0) {
        console.error('ì†ŒìŠ¤ ì¹´í…Œê³ ë¦¬ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', sourceCategoryName);
        return;
      }
      
      if (targetCategoryRow.length === 0) {
        console.error('íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', targetCategoryName);
        return;
      }
      
      // 2ë‹¨ê³„: í–‰ë“¤ ì´ë™ (ì¹´í…Œê³ ë¦¬ í–‰ + ëª¨ë“  ì´ë²¤íŠ¸ í–‰)
      var sourceRows = [sourceCategoryRow[0]].concat(sourceEventRows.toArray());
      
      console.log('ì´ë™í•  ì´ í–‰ ìˆ˜:', sourceRows.length);
      
      if (insertBefore) {
        // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ ìœ„ì— ì‚½ì… (ì—­ìˆœìœ¼ë¡œ ì‚½ì…í•˜ì—¬ ìˆœì„œ ìœ ì§€)
        for (var i = sourceRows.length - 1; i >= 0; i--) {
          $(sourceRows[i]).detach().insertBefore(targetCategoryRow);
        }
        console.log('íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ ìœ„ì— ì‚½ì… ì™„ë£Œ');
      } else {
        // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ì˜ ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ ë‹¤ìŒì— ì‚½ì…
        var insertAfter = targetEventRows.length > 0 ? targetEventRows.last() : targetCategoryRow;
        sourceRows.forEach(function(row) {
          $(row).detach().insertAfter(insertAfter);
          insertAfter = $(row); // ë‹¤ìŒ ì‚½ì… ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        });
        console.log('íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ ë’¤ì— ì‚½ì… ì™„ë£Œ');
      }
      
      console.log('íƒ€ì„ë¼ì¸ ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ ì™„ë£Œ');
    }
  }

  // íƒ€ì„ë¼ì¸ì˜ ëª¨ë“  ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateLineHeight() {
    var timelineBody = $('.timeline-body');

    console.log( "updateLineHeight!!" );
    
    if (timelineBody.length > 0) {
      var timelineHeight = timelineBody[0].scrollHeight; // ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì „ì²´ ë†’ì´
      
      // today-line ë†’ì´ ì—…ë°ì´íŠ¸
      var todayLine = $('.today-line');
      if (todayLine.length > 0) {
        var todayNewHeight = timelineHeight + 50; // top: -50px ë³´ì •
        todayLine.css('height', todayNewHeight + 'px');
      }
      
      // date-grid-line ë†’ì´ ì—…ë°ì´íŠ¸
      var dateGridLines = $('.date-grid-line');
      if (dateGridLines.length > 0) {
        dateGridLines.css('height', timelineHeight + 'px');
      }
    }
  }

  // RGB ìƒ‰ìƒì„ HEXë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
  function rgbToHex(rgb) {
    if (!rgb || rgb.indexOf('rgb') !== 0) return rgb;
    
    var rgbMatch = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
    if (!rgbMatch) return rgb;
    
    function hex(x) {
      return ("0" + parseInt(x).toString(16)).slice(-2);
    }
    
    return "#" + hex(rgbMatch[1]) + hex(rgbMatch[2]) + hex(rgbMatch[3]);
  }

  // ìŠ¤ì¼€ì¤„ ë°” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateScheduleBar(scheduleBar, scheduleData) {
    var startDate = new Date(scheduleData.start_date);
    var endDate = new Date(scheduleData.end_date);
    var startDateObj = new Date(<%= start_date.to_time.to_i * 1000 %>);
    
    // ìœ„ì¹˜ ê³„ì‚° - ë‹¤ë¥¸ í•¨ìˆ˜ë“¤ê³¼ ë™ì¼í•œ ë°©ì‹ ì‚¬ìš©
    var startDayIndex = Math.round((startDate - startDateObj) / (1000 * 60 * 60 * 24));
    var endDayIndex = Math.round((endDate - startDateObj) / (1000 * 60 * 60 * 24));
    var left = startDayIndex * cellWidth;
    var width = (endDayIndex - startDayIndex) * cellWidth;
    
    // ìƒ‰ìƒ ìš°ì„ ìˆœìœ„: ê°œë³„ ìƒ‰ìƒ > ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ > ì´ìŠˆ ìƒ‰ìƒ
    var scheduleColor = scheduleData.color;
    var categoryColor = getCategoryColor(currentEditingScheduleBar.categoryName);
    
    // ìŠ¤ì¼€ì¤„ ë°” ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    scheduleBar.removeClass(function(index, className) {
      return (className.match(/issue-\S+/g) || []).join(' ');
    });
    scheduleBar.removeClass('custom-color');
    
    if (scheduleColor) {
      // ê°œë³„ ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì ìš©
      scheduleBar.addClass('custom-color');
      scheduleBar.css('background-color', scheduleColor);
    } else if (categoryColor) {
      // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì ìš©
      scheduleBar.addClass('custom-color');
      scheduleBar.css('background-color', categoryColor);
    } else {
      // ê¸°ë³¸ ì´ìŠˆ ìƒ‰ìƒ ì ìš©
      scheduleBar.addClass('issue-' + scheduleData.issue);
      scheduleBar.css('background-color', '');
    }
    
    // ìœ„ì¹˜ì™€ í¬ê¸° ì—…ë°ì´íŠ¸
    scheduleBar.css({
      left: left + 'px',
      width: width + 'px'
    });
    
    // í…ìŠ¤íŠ¸ì™€ title ì—…ë°ì´íŠ¸
    scheduleBar.find('.project-bar-text').html(scheduleData.name.replace(/\n/g, '<br>'));
    scheduleBar.attr('title', scheduleData.name + ' (' + 
      formatLocalDate(startDate) + ' ~ ' + 
      formatLocalDate(endDate) + ')');
    // ì›ë¬¸ ìŠ¤ì¼€ì¤„ëª… ì†ì„± ê°±ì‹ 
    scheduleBar.attr('data-schedule-name', scheduleData.name);
    
    // ì´ìŠˆ ë²ˆí˜¸ë¥¼ data ì†ì„±ìœ¼ë¡œ ì €ì¥
    scheduleBar.attr('data-issue-number', scheduleData.issue);
    
    // ê¸°ì¡´ ì´ìŠˆ ë§í¬ ì•„ì´ì½˜ ì œê±°
    scheduleBar.find('.issue-link-icon').remove();
    
    // ì´ìŠˆ ë§í¬ ì•„ì´ì½˜ ì¶”ê°€ (ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©)
    var issueLinkIcon = generateIssueLinkIcon(scheduleData.issue);
    if (issueLinkIcon) {
      scheduleBar.append(issueLinkIcon);
    }
    
    console.log('ìŠ¤ì¼€ì¤„ ë°” ì—…ë°ì´íŠ¸ ì™„ë£Œ:', scheduleData.name);
    
    // ì‚¬ì´ë“œë°” í”„ë¡œì íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
    updateProjectInfo(currentEditingScheduleBar.eventName, currentEditingScheduleBar.categoryName);
  }

  // í”„ë¡œì íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ìŠ¤ì¼€ì¤„ ê°œìˆ˜ë§Œ í‘œì‹œ)
  function updateProjectInfo(eventName, categoryName) {
    // í•´ë‹¹ ì´ë²¤íŠ¸ì˜ íƒ€ì„ë¼ì¸ í–‰ ì°¾ê¸°
    var timelineRow = $('.timeline-row[data-event-name="' + eventName + '"][data-category-name="' + categoryName + '"]');
    if (timelineRow.length === 0) return;
    
    // ìŠ¤ì¼€ì¤„ ë°”ë“¤ ìˆ˜ì§‘
    var scheduleBars = timelineRow.find('.project-bar');
    var scheduleCount = scheduleBars.length;
    
    var info = scheduleCount + 'ê°œ ìŠ¤ì¼€ì¤„';
    
    // ì‚¬ì´ë“œë°”ì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ ì°¾ì•„ì„œ ì •ë³´ ì—…ë°ì´íŠ¸
    $('.project-item').each(function() {
      var projectItem = $(this);
      var projectName = projectItem.find('.project-name').text().trim();
      if (projectName === eventName) {
        projectItem.find('.project-info').text(info);
        return false; // ì°¾ì•˜ìœ¼ë¯€ë¡œ ë£¨í”„ ì¢…ë£Œ
      }
    });
    
    console.log('í”„ë¡œì íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸:', eventName, '->', info);
  }

  // currentTimelineNameê³¼ ì¼ì¹˜í•˜ëŠ” íƒ­ì„ ì„ íƒí•˜ëŠ” í•¨ìˆ˜
  function selectTimelineTab(timelineName) {
    // ëª¨ë“  íƒ­ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
    $('.timeline-tab').removeClass('selected');
    
    // ì¼ì¹˜í•˜ëŠ” íƒ­ ì°¾ê¸°
    var targetTab = $('.timeline-tab[data-timeline-name="' + timelineName + '"]');
    
    // í•´ë‹¹ íƒ­ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ íƒ­ ì„ íƒ
    if (targetTab.length === 0) {
      console.warn('íƒ­ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', timelineName, '- ì²« ë²ˆì§¸ íƒ­ ì„ íƒ');
      targetTab = $('.timeline-tab').first();
      if (targetTab.length > 0) {
        var firstTimelineName = targetTab.data('timeline-name');
        currentTimelineName = firstTimelineName;
        timelineName = firstTimelineName;
      }
    }
    
    // ì„ íƒëœ íƒ­ì— selected í´ë˜ìŠ¤ ì¶”ê°€
    targetTab.addClass('selected');
    
    console.log('íƒ­ ì„ íƒë¨:', timelineName);
  }
  
</script>